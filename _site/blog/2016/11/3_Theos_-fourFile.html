<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>iOS逆向系列3_Theos_file简介及Logos基本语法</title>
  <meta name="description" content="">
  <meta name="author" content="leopardpan">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="iOS逆向系列3_Theos_file简介及Logos基本语法">
  <meta name="twitter:description" content="">
  
  <meta property="og:type" content="article">
  <meta property="og:title" content="iOS逆向系列3_Theos_file简介及Logos基本语法">
  <meta property="og:description" content="">
  
  <link rel="icon" type="image/png" href="/images/favicon.png" />
  <link href="/images/favicon.png" rel="shortcut icon" type="image/png">
  
  <link rel="stylesheet" href="/css/main.css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="http://localhost:4000/blog/2016/11/3_Theos_-fourFile.html">
  <link rel="alternate" type="application/rss+xml" title="三行代码" href="http://localhost:4000/feed.xml">
  
  <meta name="google-site-verification" content="1-1ZlHoRvM0T2FqPbW2S-qLgYXN6rsn52kErlMPd_gw" />

<!-- 站点统计 --> 
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>


<!-- 百度统计 -->
  
  <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?d9432112fb859bf7276f8399641fb0c5";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
  </script>
  

<!-- google 统计 -->
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-85978943-1', 'auto');
      ga('send', 'pageview');
  </script>
  

</head>


  <body>

    <span class="mobile btn-mobile-menu">        
      <div class="nav_container">
         <nav class="nav-menu-item" style = "float:right">
            <i class="nav-menu-item">
              <a href="/#blog" title="" class="blog-button">  主页
              </a>
            </i>
            
                <i class="nav-menu-item">

                  <a href="/nav/archive" title="archive" class="btn-mobile-menu__icon">
                      归档
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/nav/tags" title="tags" class="btn-mobile-menu__icon">
                      分类
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/nav/messages" title="messages" class="btn-mobile-menu__icon">
                      留言
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/about" title="about" class="btn-mobile-menu__icon">
                      关于
                  </a>
                </i>
            
          </nav>
      </div>
    </span>
    
    <header class="panel-cover panel-cover--collapsed" style="background-image: url('/images/background-cover.jpg')">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <!-- 头像效果-start -->
        <div class="ih-item circle effect right_to_left">            
            <a href="/#blog" title="前往 三行代码 的主页" class="blog-button">
                <div class="img"><img src="/images/avatar.jpg" alt="img"></div>
                <div class="info">
                    <div class="info-back">
                        <h2> 
                            
                                三行代码
                            
                        </h2>
                        <p>
                           
                                iOS/H5/安卓
                            
                        </p>
                    </div>
                </div>
            </a>
        </div>
        <!-- 头像效果-end -->
        <h1 class="panel-cover__title panel-title"><a href="/#blog" title="link to homepage for 三行代码" class="blog-button">三行代码</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">技术博客</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">欢迎访问我的博客</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        
        
        

        <div class="navigation-wrapper">
          <div>
            <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">主页</a></li>
                
                  <li class="navigation__item"><a href="/nav/archive" title="archive">归档</a></li>
                
                  <li class="navigation__item"><a href="/nav/tags" title="tags">分类</a></li>
                
                  <li class="navigation__item"><a href="/nav/messages" title="messages">留言</a></li>
                
                  <li class="navigation__item"><a href="/about" title="about">关于</a></li>
                
              </ul>
            </nav>
          </div>          
        </div>


        </div>
      </div>
    </div>
    
    
    <div class="panel-cover--overlay cover-disabled"></div>
    
  </div>
 
</header>



    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title">iOS逆向系列3_Theos_file简介及Logos基本语法</h1>
    <div class="post-meta">
      <img src="/images/calendar.png" width="20px"/> 
      <time datetime="2016-11-04 00:00:00 +0800" itemprop="datePublished" class="post-meta__date date">2016-11-04
      </time>  
    <p>  
      <span id="busuanzi_container_page_pv"> | 阅读：<span id="busuanzi_value_page_pv"></span>次</span>
    </p>
    </div>
  </header>
<script type="text/javascript" color="0,102,51" opacity='0.6' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>
  <section class="post">
    <ul id="markdown-toc">
  <li><a href="#1说明" id="markdown-toc-1说明">1、说明</a></li>
  <li><a href="#2makefile" id="markdown-toc-2makefile">2、Makefile</a>    <ul>
      <li><a href="#21-基本配置" id="markdown-toc-21-基本配置">2.1 基本配置</a></li>
      <li><a href="#22-指定处理器架构" id="markdown-toc-22-指定处理器架构">2.2 指定处理器架构</a></li>
      <li><a href="#23-指定sdk版本" id="markdown-toc-23-指定sdk版本">2.3 指定SDK版本</a></li>
      <li><a href="#24-导入framework" id="markdown-toc-24-导入framework">2.4 导入framework</a></li>
      <li><a href="#25-链接mach-o对象mach-o-object" id="markdown-toc-25-链接mach-o对象mach-o-object">2.5 链接Mach-O对象（Mach-O object）</a></li>
    </ul>
  </li>
  <li><a href="#3tweakxm" id="markdown-toc-3tweakxm">3、Tweak.xm</a>    <ul>
      <li><a href="#31-hook" id="markdown-toc-31-hook">3.1 %hook</a></li>
      <li><a href="#32-log" id="markdown-toc-32-log">3.2 %log</a></li>
      <li><a href="#33-orig" id="markdown-toc-33-orig">3.3 %orig</a></li>
      <li><a href="#34-group" id="markdown-toc-34-group">3.4 %group</a></li>
      <li><a href="#35-init" id="markdown-toc-35-init">3.5 %init</a></li>
      <li><a href="#36-ctor" id="markdown-toc-36-ctor">3.6 %ctor</a></li>
      <li><a href="#37-new" id="markdown-toc-37-new">3.7 %new</a></li>
      <li><a href="#38-c" id="markdown-toc-38-c">3.8 %c</a></li>
    </ul>
  </li>
  <li><a href="#4control" id="markdown-toc-4control">4、control</a></li>
  <li><a href="#5projectby3codeplist" id="markdown-toc-5projectby3codeplist">5、projectBy3code.plist</a></li>
</ul>

<p><strong>待整理</strong></p>

<p>在iosOpenDev之前，很多ios插件都使用theos编译开发，现在使用theos开发的人也不在少数。theos 有自己的模板用于开发一系列的插件程序，所以在早期开发的插件中基本上都是使用theos。
怎样安装theos，在前边的文章已有介绍：<a href="">传送门</a></p>

<h2 id="1说明">1、说明</h2>
<p>使用theos创建工程：projectBy3code。文件夹内有四个文件：
projectBy3code.plist、Makefile、Tweak.xm、control 下面分别介绍这四个文件</p>

<p>参考教程：</p>

<p>Logos 语法
<a href="http://iphonedevwiki.net/index.php/Logos">http://iphonedevwiki.net/index.php/Logos</a></p>

<p>Makefile
<a href="http://www.gnu.org/software/make/manual/html_node/Makefiles.html">http://www.gnu.org/software/make/manual/html_node/Makefiles.html</a></p>

<p>debian的官网
<a href="http://www.debian.org/doc/debian-policy/ch-controlfields.html">http://www.debian.org/doc/debian-policy/ch-controlfields.html</a></p>

<h2 id="2makefile">2、Makefile</h2>

<h5 id="21-基本配置">2.1 基本配置</h5>

<p>Makefile文件指定工程用到的文件、框架、库等信息。projectBy3code的Makefile内容以及解释如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#固定写法:系统变量，不要更改。
#告诉theOS在编译脚本中包括共同的make命令，避免做重复的make编译工作
include $(THEOS)/makefiles/common.mk

#tweak的名字，即用Theos创建工程时指定的“Project Name”，跟control文件中的“Name”字段对应，不要更改。
TWEAK_NAME = projectBy3code

#tweak包含的源文件（不包括头文件），多个文件间以空格分隔，如： projectBy3code_FILES = Tweak.xm Hook.xm New.x ObjC.m ObjC++.mm.头文件是可以按需修改的。
#这里是需要编译的文件列表，注意：不要把头文件添加到这里。如果你要添加一个新的.m或者.mm文件到项目中，确保在这里添加新的文件的名称，否则将不会建立编译连接。
projectBy3code_FILES = Tweak.xm

#根据不同的Theos工程类型，通过include命令指定不同的.mk文件；在逆向工程初级阶段，我们开发的一般是Application、Tweak和Tool三种类型的程序，它们对应的.mk文件分别是application.mk、tweak.mk和tool.mk，可以按需更改。	
include $(THEOS_MAKE_PATH)/tweak.mk

#tweak安装之后杀掉SpringBoard进程，好让CydiaSubstrate在进程启动时加载对应的dylib。
after-install::
		install.exec "killall -9 SpringBoard; killall -9 Instantiating; killall -9 iphone/tweak; killall -9 in; killall -9 projectBy3code/..."
</code></pre>
</div>

<p>是不是非常简单？Makefile里的默认内容确实非常简单，如何指定SDK版本？怎么导入framework？lib文件在哪里链接？，面包会有的，牛奶也会有的。下面介绍：</p>

<h5 id="22-指定处理器架构">2.2 指定处理器架构</h5>

<p><strong>这里不需要明确的指出，可以不加这一条！！原因是5s使用的64位处理器，不能用armv7指令集，所以需要在Makefile里将armv7更改为arm64，因此不要加，可能得不偿失.除非明确，否则不要加如下代码</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>ARCHS = armv7 arm64
</code></pre>
</div>

<p>上面的语句在表示不同的处理器架构，采用arm64架构的App不兼容armv7/armv7s架构，必须适配arm64架构的dylib。
You shouldn’t need to explicitly set ARCHS unless you have a very good reason. Theos will always ensure it is set to an appropriate value for your SDK and deployment targets.</p>

<h5 id="23-指定sdk版本">2.3 指定SDK版本</h5>

<p>默认是：iphone:clang:latest:latest。意即meaning to build for iOS, using clang, with the latest SDK version, deploying to support iOS versions matching the SDK version, or newer。</p>

<p>SDK可以放在xcode的包路径里面，或者最好的是放在theos里，然后设置路径即可。
方法如下：
 you should edit ~/.theosrc (which probably doesn’t exist, so create it) and insert something along the lines of:</p>

<p>SDKVERSION = 9.3
SYSROOT = $(THEOS)/sdks/iPhoneOS9.3.sdk</p>

<p>TARGET = iphone::9.2:9.0</p>

<p>Which indicates that you are building for iOS, using SDK 9.2, and intending to support iOS 9.0 and newer.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>TARGET = iphone:latest:8.0
</code></pre>
</div>

<p>比如：TARGET = iphone:8.1:8.0
   上面的语句即指定采用8.1版本的SDK，且发布对象为iOS 8.0及以上版本。也可以把“Base SDK”设置为“latest”，指定以Xcode附带的最新版本SDK编译，如：TARGET = iphone:latest:8.0</p>

<h5 id="24-导入framework">2.4 导入framework</h5>
<p>这里包括你想用到框架的名称</p>

<div class="highlighter-rouge"><pre class="highlight"><code>projectBy3code_FRAMEWORKS =  UIKit CoreTelephony CoreAudio
</code></pre>
</div>

<p>例如：projectBy3code_FRAMEWORKS = UIKit CoreTelephony CoreAudio
上面的语句所展示的功能没什么多说的，但既然是tweak开发，很多朋友关注的应该是如何导入private framework吧？很简单，用下面的语句即可：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>projectBy3code_PRIVATE_FRAMEWORKS = AppSupport ChatKit IMCore 例如：projectBy3code_PRIVATE_FRAMEWORKS = AppSupport ChatKit IMCore
</code></pre>
</div>

<p>虽然只是多了个“PRIVATE”，但有一点要注意：private framework是AppStore开发所不允许使用的，它的内容在每个iOS版本之间可能发生变化，在导入之前，一定要确定导入的private framework确实存在。举一个例子，如果你的tweak打算兼容iOS 7和iOS 8两个版本，那么Makefile可写成如下内容：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ARCHS = armv7 arm64
TARGET = iphone:latest:7.0
include theos/makefiles/common.mk
TWEAK_NAME = projectBy3code
projectBy3code_FILES = Tweak.xm
projectBy3code_PRIVATE_FRAMEWORK = BaseBoard
include $(THEOS_MAKE_PATH)/tweak.mk
after-install::
      install.exec "killall -9 SpringBoard"
</code></pre>
</div>
<p>上面的语句可以成功编译和链接，并不会报错。但是，因为BaseBoard这个private framework只存在于8.0及以上版本的SDK里，在iOS 7里是没有的，所以这个tweak在iOS 7中会因找不到framework而无法正常工作。这种情况可以通过弱链接（谷歌搜索“makefile weak linking”）或dlopen()、dlsym()和dlclose()系列函数动态调用private framework来解决。</p>

<h5 id="25-链接mach-o对象mach-o-object">2.5 链接Mach-O对象（Mach-O object）</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>projectBy3code_LDFLAGS = -lx
</code></pre>
</div>

<p>Theos采用GNU Linker来链接Mach-O对象，包括.dylib、.a和.o。在Terminal中输入“man ld”，定位到“-lx”部分，它是这么写的：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>“-lx This option tells the linker to search for libx.dylib or libx.a in the library search path.If string x is of the form y.o,then that file is searched for in the “same places,but without prepending`lib’or appending`.a’or`.dylib’to the filename.”
</code></pre>
</div>

<p>大致意思是说，-lx代表链接libx.a或libx.dylib，即给“x”加上“lib”的前缀，以及“.a”或“.dylib”的后缀；如果x是“y.o”的形式，则直接链接y.o，不加任何前缀或后缀。iOS支持链接的Mach-O对象全是以“libx.dylib”和“y.o”形式命名的，完全兼容GNU Linker。“这样，链接Mach-O对象就很方便了。例如，要链接libsqlite3.0.dylib、libz.dylib和dylib1.o，像下面这么写就可以了：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>projectBy3code_LDFLAGS = -lz –lsqlite3.0 –dylib1.o
</code></pre>
</div>

<p>稍后还有一个字段需要介绍，但一般来说，Makefile中定义了以上字段就已经完全够用了；更详细的Makefile介绍，可以参阅<a href="http://www.gnu.org/software/make/manual/html_node/Makefiles.html">http://www.gnu.org/software/make/manual/html_node/Makefiles.html</a></p>

<h2 id="3tweakxm">3、Tweak.xm</h2>
<p>用Theos创建tweak工程，默认生成的源文件是Tweak.xm。“xm”中的“x”代表这个文件支持Logos语法，如果后缀名是单独一个“x”，说明源文件支持Logos和C语法；如果后缀名是“xm”，说明源文件支持Logos和C/C++语法，与“m”和“mm”的区别类似。Tweak.xm的内容如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cm">/* How to Hook with Logos
Hooks are written with syntax similar to that of an Objective-C @implementation.”
“You don't need to #include &lt;substrate.h&gt;, it will be done automatically, as will
the generation of a class list and an automatic constructor.
%hook ClassName
// Hooking a class method
+ (id)sharedInstance {
        return %orig;
}
// Hooking an instance method with an argument.
- (void)messageName:(int)argument {
      %log; // Write a message about this call, including its class, name and arguments, to the system log.
      %orig; // Call through to the original function with its original arguments.
      %orig(nil); // Call through to the original function with a custom argument.
      // If you use %orig(), you MUST supply all arguments (except for self and _cmd, the automatically generated ones.)
}
// Hooking an instance method with no arguments.
- (id)noArguments {
      %log;
      id awesome = %orig;
      [awesome doSomethingElse];
      return awesome;
}
// Always make sure you clean up after yourself; Not doing so could have grave consequences!
%end
*/</span>
</code></pre>
</div>

<p>这就是最基本的Logos语法，包含%hook、%log、%orig这3个预处理指令，它们的作用如下。</p>

<h5 id="31-hook">3.1 %hook</h5>

<p>指定需要hook的class，必须以%end结尾，如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SpringBoard
- (void)_menuButtonDown:(id)down
{
    NSLog(@"You've pressed home button.");
    %orig; // call the original _menuButtonDown:
}
%end
</code></pre>
</div>

<p>这段代码的意思是钩住（hook）SpringBoard类里的_menuButtonDown:函数，先将一句话写入syslog，再执行函数的原始操作。</p>

<h5 id="32-log">3.2 %log</h5>

<p>该指令在%hook内部使用，将函数的类名、参数等信息写入syslog，可以以%log([(<type>)<expr>,...])的格式追加其他打印信息，如下：</expr></type></p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SpringBoard
- (void)_menuButtonDown:(id)down
{
  %log((NSString *)@"iOSRE", (NSString *)@"Debug");
  %orig; // call the original _menuButtonDown:
}
%end 打印结果如下：

Dec  3 10:57:44 FunMaker-5 SpringBoard[786]: -[&lt;SpringBoard: 0x150eb800&gt; _menuBu-ttonDown:+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    Timestamp:           75607608282
    Total Latency:       20266 us
    SenderID:            0x0000000100000190
    BuiltIn:             1
    AttributeDataLength: 16
    AttributeData:       01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    ValueType:           Absolute
    EventType:           Keyboard
    UsagePage:           12
    Usage:               64
    Down:                1
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    ]: iOSRE, Debug
</code></pre>
</div>

<h5 id="33-orig">3.3 %orig</h5>

<p>该指令在%hook内部使用，执行被钩住（hook）的函数的原始代码，如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SpringBoard
- (void)_menuButtonDown:(id)down
{
  NSLog(@"You've pressed home button.");
  %orig; // call the original _menuButtonDown:
}
%end
</code></pre>
</div>

<p>如果去掉%orig，那么原始函数不会得到执行，例如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SpringBoard
- (void)_menuButtonDown:(id)down
{
  NSLog(@"You've pressed home button but it's not functioning.");
}
%end
</code></pre>
</div>

<p>还可以利用%orig更改原始函数的参数，例如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SBLockScreenDateViewController
- (void)setCustomSubtitleText:(id)arg1 withColor:(id)arg2
{
  %orig(@"iOS 8 App Reverse Engineering", arg2);
}
%end 上边就修改掉了锁屏显示，原本显示日期的地方就变掉了。
</code></pre>
</div>

<p><strong><em>除了%hook、%log、%orig以外，Logos常用的预处理指令还有%group、%init、%ctor、%new、%c，下面继续逐一介绍。</em></strong></p>

<h5 id="34-group">3.4 %group</h5>

<p>该指令用于将%hook分组，便于代码管理及按条件初始化分组（含义稍后有详细解释），必须以%end结尾；一个%group可以包含多个%hook，所有不属于某个自定义group的%hook会被隐式归类到%group_ungrouped中。%group的用法如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%group iOS7Hook
%hook iOS7Class
- (id)iOS7Method
{
    id result = %orig;
    NSLog(@"This class &amp; method only exist in iOS 7.");
    return result;
}
%end
%end // iOS7Hook
%group iOS8Hook
%hook iOS8Class
- (id)iOS8Method
{
    id result = %orig;
    NSLog(@"This class &amp; method only exist in iOS 8.");
    return result;
}
%end
%end // iOS8Hook
%hook SpringBoard
-(void)powerDown
{
    %orig;
}
%end
</code></pre>
</div>

<p>这段代码的意思是在%group iOS7Hook中钩住iOS7Class的iOS7Method，在%group iOS8Hook中钩住iOS8Class的iOS8Method函数，然后在%group_ungrouped中钩住SpringBoard类的powerDown函数。</p>

<p><strong>需要注意的是，%group必须配合下面的%init使用才能生效。</strong></p>

<h5 id="35-init">3.5 %init</h5>

<p>该指令用于初始化某个%group，必须在%hook或%ctor内调用；如果带参数，则初始化指定的group，如果不带参数，则初始化_ungrouped，如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#ifndef kCFCoreFoundationVersionNumber_iOS_8_0
#define kCFCoreFoundationVersionNumber_iOS_8_0 1140.10
#endif
%hook SpringBoard
- (void)applicationDidFinishLaunching:(id)application
{
    %orig;
    %init; // Equals to %init(_ungrouped)
    if (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_7_0 &amp;&amp; kCFCoreFoundationVersionNumber &lt; kCFCoreFoundationVersionNumber_iOS_8_0) %init(iOS7Hook);
    if (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_8_0) init(iOS8Hook);
}
%end
</code></pre>
</div>

<p><strong>只有调用了%init，对应的%group才能起作用，切记切记！</strong></p>

<h5 id="36-ctor">3.6 %ctor</h5>

<p>tweak的constructor，完成初始化工作；如果不显式定义，Theos会自动生成一个%ctor，并在其中调用%init(_ungrouped)。因此，</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SpringBoard
- (void)reboot
{
    NSLog(@"If rebooting doesn't work then I'm screwed.");
    %orig;
}
%end”
</code></pre>
</div>

<p>可以成功生效，因为Theos隐式定义了如下内容：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%ctor
{
    %init(_ungrouped);
}
</code></pre>
</div>

<p>而</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SpringBoard
- (void)reboot
{
    NSLog(@"If rebooting doesn't work then I'm screwed.");
    %orig;
}
%end
%ctor
{
    // Need to call %init explicitly!
}
</code></pre>
</div>

<p>里的%hook无法生效，因为这里显式定义了%ctor，却没有显式调用%init，%group(_ungrouped)不起作用。%ctor一般可以用来初始化%group，以及进行MSHookFunction等操作，如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#ifndef kCFCoreFoundationVersionNumber_iOS_8_0
#define kCFCoreFoundationVersionNumber_iOS_8_0 1140.10
#endif
%ctor
{
    %init;
    if (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_7_0 &amp;&amp; kCFCoreFoundationVersionNumber &lt; kCFCoreFoundationVersionNumber_iOS_8_0) %init(iOS7Hook);
    if (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_8_0) %init(iOS8Hook);
    MSHookFunction((void *)&amp;AudioServicesPlaySystemSound,
                (void *)&amp;replaced_AudioServicesPlaySystemSound,
            (void **)&amp;original_AudioServicesPlaySystemSound);
}
</code></pre>
</div>

<p>注意，%ctor不需要以%end结尾。</p>

<h5 id="37-new">3.7 %new</h5>

<p>在%hook内部使用，给一个现有class添加新函数，功能与class_addMethod相同。它的用法如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>%hook SpringBoard
%new
- (void)namespaceNewMethod
{
  NSLog(@"We've added a new method to SpringBoard.");
}
%end
</code></pre>
</div>

<p>有的朋友可能会问，Objective-C的category语法也可以给现有class添加新函数，为什么还需要%new呢？其实原因就在于category与class_addMethod的区别，前者是静态的，而后者是动态的。那么在这种情况下，静态还是动态，有什么关系呢？当然有关系，尤其是当class来自某个可执行文件的时候。举个例子，上面的代码给SpringBoard类添加了一个新方法，如果使用category，代码应该是下面这样：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">SpringBoard</span> <span class="p">(</span><span class="nl">iOSRE</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">namespaceNewMethod</span><span class="p">;</span>
<span class="k">@end</span>
<span class="k">@implementation</span> <span class="nc">SpringBoard</span> <span class="p">(</span><span class="nl">iOSRE</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">namespaceNewMethod</span>
<span class="p">{</span>
  <span class="n">NSLog</span><span class="p">(</span><span class="s">@"We've added a new method to SpringBoard."</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre>
</div>

<p>如果尝试编译上面的代码，会得到“error：cannot find interface declaration for‘SpringBoard’”的报错信息，即编译器找不到SpringBoard类的定义。可以构造一个SpringBoard的定义，骗过编译器，如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">SpringBoard</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="k">@end</span>
<span class="k">@interface</span> <span class="nc">SpringBoard</span> <span class="p">(</span><span class="nl">iOSRE</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">namespaceNewMethod</span><span class="p">;</span>
<span class="k">@end</span>
<span class="k">@implementation</span> <span class="nc">SpringBoard</span> <span class="p">(</span><span class="nl">iOSRE</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">namespaceNewMethod</span>
<span class="p">{</span>
  <span class="n">NSLog</span><span class="p">(</span><span class="s">@"We've added a new method to SpringBoard."</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre>
</div>

<p>重新编译，仍然会报错，如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Undefined symbols for architecture armv7:
"_OBJC_CLASS_$_SpringBoard", referenced from:
  l_OBJC_$_CATEGORY_SpringBoard_$_iOSRE in Tweak.xm.b1748661.o
ld: symbol(s) not found for architecture armv7
clang: error: linker command failed with exit code 1 (use -v to see invocation)
</code></pre>
</div>

<p>ld找不到“SpringBoard”的定义。一般来说，iOS程序员在碰到这个错误时的第一反应是：“是不是忘了导入哪个framework？”，但是转念一想，SpringBoard类是SpringBoard这个App里的一个类，而不是一个framework，要怎么导入？现在你是不是觉得%new非常可爱了呢？</p>

<h5 id="38-c">3.8 %c</h5>

<p>该指令的作用等同于objc_getClass或NSClassFromString，即动态获取一个类的定义，在%hook或%ctor内使用。
Logos的预处理指令还有%subclass和%config，感兴趣的读者可以移步http://iphonedevwiki.net/index.php/Logos一探究竟</p>

<h2 id="4control">4、control</h2>

<p>control文件记录了deb包管理系统所需的基本信息，会被打包进deb包里。projectBy3code里control文件的内容如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Package: com.jxc.projectBy3code
Name: projectBy3code
Depends: mobilesubstrate
Version: 0.0.1
Architecture: iphoneos-arm
Description: An awesome MobileSubstrate tweak!
Maintainer: gyjrong
Author: 3code
Section: Tweaks
</code></pre>
</div>

<p>其中：</p>

<ul>
  <li>Package字段用于描述这个deb包的名字，采用的命名方式同bundle identifier类似，均为反向DNS格式，可以按需更改；</li>
  <li>Name字段用于描述这个工程的名字，可以按需更改；</li>
  <li>Depends字段用于描述这个deb包的“依赖”。“依赖”指的是这个程序运行的基本条件，可以填写固件版本或其他程序，如果当前iOS不满足“依赖”中定义的条件，则此tweak无法正常运行。如</li>
  <li>Depends: mobilesubstrate, firmware (&gt;= 8.0)
表示当前iOS版本必须在8.0以上，且必须安装CydiaSubstrate，才能正常运行这个tweak，可以按需更改。</li>
  <li>Version字段用于描述这个deb包的版本号，可以按需更改；</li>
  <li>Architecture字段用于描述deb包安装的目标设备架构，不要更改；</li>
  <li>Description字段是deb包的简单介绍，可以按需更改；</li>
  <li>Maintainter字段用于描述deb包的维护人，例如BigBoss源中所有deb包的维护人均为BigBoss，而非软件作者，可以按需更改；</li>
  <li>Author字段用于描述tweak的作者（注意与Maintainer的区别），可以按需更改；</li>
  <li>Section字段用于描述deb包所属的程序类别，不要更改。</li>
</ul>

<p>control文件中可以自定义的字段还有很多，但上面这些信息就已经足够了。更全面的说明可以参阅debian的官方网站（http://www.debian.org/doc/debian-policy/ch-controlfields.html）或留意其他deb包里的control文件。值得注意的是，Theos在打包deb时会对control文件作进一步处理，上面的control文件在得到处理后内容变为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>原始：
“Package: com.iosre.projectBy3code
Name: projectBy3code
Depends: mobilesubstrate”
“Version: 0.0.1
Architecture: iphoneos-arm
Description: An awesome MobileSubstrate tweak!
Maintainer: snakeninny
Author: snakeninny
Section: Tweaks”

处理后：
Package: com.iosre.projectBy3code
Name: projectBy3code
Depends: mobilesubstrate
Architecture: iphoneos-arm
Description: An awesome MobileSubstrate tweak!
Maintainer: snakeninny
Author: snakeninny
Section: Tweaks
Version: 0.0.1-1
Installed-Size: 104
</code></pre>
</div>

<p>这里Theos更改了Version字段，用以表示Theos的打包次数，方便管理；</p>

<p>增加了一个Installed-Size字段，用以描述deb包安装后的估算大小，可能会与实际大小有偏差，但不要更改。
control文件中的很多信息直接体现在Cydia中，如下所示，大家可以对比看看。</p>

<h2 id="5projectby3codeplist">5、projectBy3code.plist</h2>

<p>这个plist文件的作用和App中的Info.plist类似，它记录了一些配置信息，描述了tweak的作用范围。我们可以用plutil，也可以用Xcode来编辑它。</p>

<p>projectBy3code.plist的最外层是一个dictionary，只有一个名为“Filter”的键,“Filter下是一系列array，可以分为三类。
<!--
![](https://ooo.0o0.ooo/2016/11/01/58182ee3ac4ce.jpeg)-->
<img src="https://ooo.0o0.ooo/2016/11/01/58182f3cc349a.jpeg" alt="" />
<img src="https://ooo.0o0.ooo/2016/11/01/58182f616c699.jpeg" alt="" />
<img src="https://ooo.0o0.ooo/2016/11/01/58182f80b74e4.jpeg" alt="" /></p>

<ul>
  <li>Bundles，指定若干bundle为tweak的作用对象：</li>
</ul>

<p>如上配置：tweak的作用对象是三个bundle，即SMSNinja、AddressBook.framework和SpringBoard。</p>

<ul>
  <li>Classes，指定若干class为tweak的作用对象：</li>
</ul>

<p>tweak的作用对象是三个class，即NSString、SBAwayController和SBIconModel。</p>

<ul>
  <li>Executables，指定若干可执行文件为tweak的作用对象：</li>
</ul>

<p>tweak的作用对象是三个可执行文件，即callservicesd、imagent和mediaserverd。</p>

<p>这三类array可以混合使用：</p>

<p><img src="https://ooo.0o0.ooo/2016/11/01/58182f9637bfa.jpeg" alt="" /></p>

<p>注意，当Filter下有不同类的array时，需要添加一个“Mode：Any”键值对。当Filter下的array只有一类时，不需要添加“Mode：Any”键值对。”</p>



  </section>
</article>

﻿<section>

            <div class="content-play">
              <p><a href="javascript:void(0)" onclick="dashangToggle()" class="dashang" title="打赏，支持一下">支持一下</a></p>
              <div class="hide_box-play"></div>
              <div class="shang_box-play">
                <a class="shang_close-play" href="javascript:void(0)" onclick="dashangToggle()" title="关闭"><img src="/images/payimg/close.jpg" alt="取消" /></a>
                <div class="shang_tit-play">
                  <p>感谢您的支持，我会继续努力的!</p>
                </div>
                <div class="shang_payimg">
                    <img src="/images/payimg/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
                </div>
              <div class="shang_payimg">    
                    <img src="/images/payimg/weipayimg.jpg" alt="扫码支持" title="扫一扫" />
                </div>
                <div class="pay_explain">扫码支持一下</div>
                <div class="shang_payselect">
                  <div class="pay_item checked" data-id="alipay">
                    <span class="pay_logo"><img src="/images/payimg/alipay.jpg" alt="支付宝" /></span>
                  </div>
                  <div class="pay_item" data-id="weipay">
                    <span class="pay_logo"><img src="/images/payimg/wechat.jpg" alt="微信" /></span>
                  </div>
                </div>
                <div class="shang_info-play">
                  <p>打开<span id="shang_pay_txt">支付宝</span>扫一扫，即可进行扫码打赏哦</p>
                </div>
              </div>
            </div>
            <script type="text/javascript">
            function dashangToggle(){
              $(".hide_box-play").fadeToggle();
              $(".shang_box-play").fadeToggle();
            }
            </script>

            <div style="text-align:center;margin:50px 0; font:normal 14px/24px 'MicroSoft YaHei';"></div>

            <style type="text/css">
              .content-play{width:80%;margin-top: 20px;margin-bottom: 10px;height:40px;}
              .hide_box-play{z-index:999;filter:alpha(opacity=50);background:#666;opacity: 0.5;-moz-opacity: 0.5;left:0;top:0;height:99%;width:100%;position:fixed;display:none;}
              .shang_box-play{width:540px;height:540px;padding:10px;background-color:#fff;border-radius:10px;position:fixed;z-index:1000;left:50%;top:50%;margin-left:-280px;margin-top:-280px;border:1px dotted #dedede;display:none;}
              .shang_box-play img{border:none;border-width:0;}
              .dashang{display:block;width:100px;margin:5px auto;height:25px;line-height:25px;padding:10px;background-color:#E74851;color:#fff;text-align:center;text-decoration:none;border-radius:10px;font-weight:bold;font-size:16px;transition: all 0.3s;}
              .dashang:hover{opacity:0.8;padding:15px;font-size:18px;color:#fff}
              .shang_close-play{float:right;display:inline-block;
                margin-right: 10px;margin-top: 20px;
              }
              .shang_logo{display:block;text-align:center;margin:20px auto;}
              .shang_tit-play{width: 100%;height: 75px;text-align: center;line-height: 66px;color: #a3a3a3;font-size: 16px;background: url('/images/payimg/cy-reward-title-bg.jpg');font-family: 'Microsoft YaHei';margin-top: 7px;margin-right:2px;}
              .shang_tit-play p{color:#a3a3a3;text-align:center;font-size:16px;}
              .shang_payimg{width:140px;padding:10px;padding-left: 80px; /*border:6px solid #EA5F00;**/margin:0 auto;border-radius:3px;height:140px;display:inline-block;}
              .shang_payimg img{display:inline-block;margin-right:10px;float:left;text-align:center;width:140px;height:140px; }
              .pay_explain{text-align:center;margin:10px auto;font-size:12px;color:#545454;}
              .shang_payselect{text-align:center;margin:0 auto;margin-top:40px;cursor:pointer;height:60px;width:500px;margin-left:110px;}
              .shang_payselect .pay_item{display:inline-block;margin-right:140px;float:left;}
              .shang_info-play{clear:both;}
              .shang_info-play p,.shang_info-play a{color:#C3C3C3;text-align:center;font-size:12px;text-decoration:none;line-height:2em;}
            </style>

       <ul class="pager">
        
        <li class="previous">
            <a href="/blog/2016/11/2_Theos_-install&run.html" data-toggle="tooltip" data-placement="top" title="iOS逆向系列2_Theos_安装编译打包运行">上一篇：  <span>iOS逆向系列2_Theos_安装编译打包运行</span>
            </a>
        </li>
        
        
        <li class="next">
            <a href="/blog/2016/11/IOS_Adopt.html" data-toggle="tooltip" data-placement="top" title=" 一道面试题里藏的IOS世界">下一篇：  <span> 一道面试题里藏的IOS世界</span>
            </a>
        </li>
        
    </ul>
</section>

<section class="post-comments">

  
    <div id="uyan_frame"></div>

    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="+'2147278'></script>

  

</section>


            <section class="footer">
    <footer>
        <div class = "footer_div">  
        <nav class="cover-navigation navigation--social">
          <ul class="navigation">

          

          
          <!-- Github -->
          <li class="navigation__item_social">
            <a href="https://github.com/mythkiven" title="@mythkiven 的 Github" target="_blank">
              <i class='social fa fa-github fa-2x'></i>
              <span class="label">Github</span>
            </a>
          </li>
          
          
          
          <!-- Twitter -->
          <li class="navigation__item_social">
            <a href="http://twitter.com/Mr3code" title="@Mr3code" target="_blank">
              <i class='social fa fa-twitter fa-2x'></i>
              <span class="label">Twitter</span>
            </a>
          </li>
          

          

          <!-- RSS -->
          <li class="navigation__item_social">
            <a href="/feed.xml" rel="author" title="RSS" target="_blank">
              <i class='social fa fa-rss fa-2x'></i>
              <span class="label">RSS</span>
            </a>
          </li>

          
          <!-- Email -->
          <li class="navigation__item_social">
            <a href="mailto:1282412855@qq.com" title="Contact me">
              <i class='social fa fa-envelope fa-2x'></i>
              <span class="label">Email</span>
            </a>
          </li>
          

          </ul>
        </nav>

        </div>

        <div class = "footer_div">  
           <p class="copyright text-muted">
            Copyright &copy; 三行代码 2017 Theme by <a href="http://jekyllthemes.org/">dearLilian</a> |
            <iframe
                style="margin-left: 2px; margin-bottom:-5px;"
                frameborder="0" scrolling="0" width="91px" height="20px"
                src="https://ghbtns.com/github-btn.html?user=mythkiven&type=star&count=true&repo=DiffuseMenu_Swift" >
            </iframe>
            <iframe
                style="margin-left: 2px; margin-bottom:-5px;"
                frameborder="0" scrolling="0" width="91px" height="20px"
                src="https://ghbtns.com/github-btn.html?user=mythkiven&type=star&count=true&repo=AD_Fastlane" >
            </iframe> 
            
            </p>
        	<div align="right">
    			<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">

          <!-- 访问统计 -->
          <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，您是第<span id="busuanzi_value_site_uv"></span>位小伙伴，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
          

        </div>
        <div>
    </footer>
</section>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

        </div>
    </div>
    
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

<script type="text/javascript" src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



    
    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    
    <script type="text/javascript" color="0,102,51" opacity='0.6' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>
  </body>

</html>
