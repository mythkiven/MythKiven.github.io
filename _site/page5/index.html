<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>3行代码</title>
    <meta name="description" content="">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="/css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/page5/">
    <link rel="alternate" type="application/rss+xml" title="3行代码" href="http://localhost:4000/feed.xml ">


<script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
     var hm = document.createElement("script");
     hm.src = "//hm.baidu.com/hm.js?d9432112fb859bf7276f8399641fb0c5";
     var s = document.getElementsByTagName("script")[0];
     s.parentNode.insertBefore(hm, s);
     })();
    </script>




    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-85978943-1', 'auto');
      ga('send', 'pageview');

    </script>

</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">3行代码</a>
        <small>技术博客</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>


                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" index>
    <div class="left">
        <h1>Welcome to 3code.info!</h1>
        <small>记录生活</small>
        <hr>
        <ul>
            
              <li>
                <h2>
                  <a class="post-link" href="/2015/10/30/SecureCRT/">SecureCRT小教程</a>
                </h2>
                <div class="label">
                    <div class="label-card">
                        <i class="fa fa-calendar"></i>2015-10-30
                    </div>
                    <div class="label-card">
                        <i class="fa fa-user"></i>3行代码
                        
                    </div>
                    <div class="label-card">
                        
                    </div>

                    <div class="label-card">
                    


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#SecureCRT" title="Category: SecureCRT" rel="category">SecureCRT</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


                    </div>

                    <div class="label-card">
                    
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <a href="/tag/#SecureCRT" title="Tag: SecureCRT" rel="tag">SecureCRT</a>
    
  

</span>

                    </div>
                </div>
                <div class="excerpt">
                    <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">安装</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">配置</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">使用</a></li>
  <li><a href="#section-3" id="markdown-toc-section-3">后记</a></li>
</ul>

<p>在window上可以通过Xshell调试网络、查看服务器日志，在Mac上没有Xshell的，最好的替换方案就是：SecureCRT。</p>

<h4 id="section">安装</h4>

<p>google安装</p>

<h4 id="section-1">配置</h4>

<p>设置UTF8：
Options—&gt;session Options—&gt;Appearance 点选设置UTF8，如下图:</p>

<p><img src="https://ooo.0o0.ooo/2016/12/02/584148ea55d87.png" alt="" /></p>

<p>设置链接：
<img src="https://ooo.0o0.ooo/2016/12/02/584149554189b.png" alt="" />
<img src="https://ooo.0o0.ooo/2016/12/02/5841498e5ab3d.png" alt="" /></p>

<h4 id="section-2">使用</h4>

<p>和终端差不多，及时展示当前的请求日志(crt-root.log)使用命令：
 # tail -f crt-root.log</p>

<p>实际效果如下：可以及时查看服务器日志啦：</p>

<p><img src="https://ooo.0o0.ooo/2016/12/02/584149b24a478.png" alt="" /></p>

<h4 id="section-3">后记</h4>

<p>一个人开发真的很屌啊，所有的工具都会用。</p>


                </div>
                <div class="read-all">
                    <a  href="/2015/10/30/SecureCRT/"><i class="fa fa-newspaper-o"></i>Read All</a>
                </div>
                <hr>
              </li>
            
              <li>
                <h2>
                  <a class="post-link" href="/2015/10/15/NSURLCache/">NSURLCache缓存的那些事</a>
                </h2>
                <div class="label">
                    <div class="label-card">
                        <i class="fa fa-calendar"></i>2015-10-15
                    </div>
                    <div class="label-card">
                        <i class="fa fa-user"></i>3行代码
                        
                    </div>
                    <div class="label-card">
                        
                    </div>

                    <div class="label-card">
                    


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#NSURLCache" title="Category: NSURLCache" rel="category">NSURLCache</a>&nbsp;
    
        <a href="/category/#缓存" title="Category: 缓存" rel="category">缓存</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


                    </div>

                    <div class="label-card">
                    
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <a href="/tag/#NSURLCache" title="Tag: NSURLCache" rel="tag">NSURLCache</a>&nbsp;
    
        <a href="/tag/#缓存" title="Tag: 缓存" rel="tag">缓存</a>
    
  

</span>

                    </div>
                </div>
                <div class="excerpt">
                    <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">基础篇</a>    <ul>
      <li><a href="#section-1" id="markdown-toc-section-1">1、扫盲普及</a></li>
      <li><a href="#get-" id="markdown-toc-get-">2、基础：GET 缓存</a></li>
      <li><a href="#post-" id="markdown-toc-post-">3、进阶：POST 缓存</a></li>
      <li><a href="#nsurlcache" id="markdown-toc-nsurlcache">4、进阶：自定义缓存策略的NSURLCache</a></li>
    </ul>
  </li>
  <li><a href="#section-2" id="markdown-toc-section-2">进阶篇</a>    <ul>
      <li><a href="#useprotocolcachepolicy---" id="markdown-toc-useprotocolcachepolicy---">1、UseProtocolCachePolicy - 默认缓存的机制</a></li>
      <li><a href="#section-3" id="markdown-toc-section-3">2、缓存高清图片</a></li>
    </ul>
  </li>
</ul>

<p>不少的开源项目的网络缓存都是自己家的轮子(譬如AFN俩独立缓存模块：AFAFImagecache (处理image)、NSURLCache(默认URL缓存))，我们现在的项目并未涉及到太复杂的缓存需求，自己造轮子不划算直接用系统的NSURLCache就OK。</p>

<p>在使用中也遇到不少坑：</p>

<ul>
  <li>响应内容过大，不会被缓存；</li>
  <li>Transfer-Encoding: Chunked  分块传输也会导致不缓存。</li>
  <li>…</li>
</ul>

<p>目前在协助子公司开发的一个项目里涉及到各种HTML5中的离线存储需求，实际用的是NSURLProtocol+NSURLCache，根据场景，用两套缓存的方案。对NSURLProtocol感兴趣的可以浏览我的另一篇关于NSURLProtocol的blog。</p>

<h3 id="section">基础篇</h3>

<h4 id="section-1">1、扫盲普及</h4>

<p>1、在iOS中，可以使用NSURLCache类缓存数据，iOS 5之前只支持内存缓存；从iOS 5开始同时支持内存缓存和硬盘缓存；iOS6.0开始，支持HTTPS缓存。</p>

<p>2、缓存分为:内存缓存\硬盘缓存。从app运行角度来说：如果程序没有退出，那么会使用内存中的缓存，如果已经退出重启，则使用硬盘缓存(读取到内存中)。</p>

<p>3、NSURLCache不支持Post请求的缓存处理，GET默认缓存：由于GET请求一般用来查询数据，POST请求一般是发大量数据给服务器处理。因此一般只对GET请求进行缓存，而不对POST请求进行缓存。</p>

<p>4、使用前提：</p>

<ul>
  <li>经常更新：不能用缓存；</li>
  <li>一成不变：果断用缓存；</li>
  <li>偶尔更新：可以定期更改缓存策略或者清除缓存</li>
  <li>GET网络请求、webview页面：果断缓存；</li>
  <li>App离线缓存功能等</li>
</ul>

<p>5、使用也很简单，几行代码搞定：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// 1 修改默认的缓存空间：
- (BOOL)application:(UIApplication *)application
didFinishLaunchingWithOptions:(NSDictionary *)launchOptions{
  NSURLCache *URLCache = [[NSURLCache alloc] initWithMemoryCapacity:4 * 1024 * 1024diskCapacity:20 * 1024 * 1024 diskPath:nil];
  [NSURLCache setSharedURLCache:URLCache];
}
// 2 设置缓存策略：
request.cachePolicy = NSURLRequestReturnCacheDataElseLoad;
OK，搞定。
</code></pre>
</div>
<p>如果不想使用缓存，上边数值设置0即可。</p>

<p>6、缓存的有效性，下文会提到，服务器返回的数据需要一个有效期，过期有效期就得更新本地的缓存。</p>

<h4 id="get-">2、基础：GET 缓存</h4>

<p>1、基本用法:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
（1）获得全局缓存对象 NSURLCache *cache = [NSURLCache sharedURLCache]; 
（2）设置内存缓存的最大容量（字节为单位，默认为512KB）- (void)setMemoryCapacity:
（3）设置硬盘缓存的最大容量（字节为单位，默认为10M）- (void)setDiskCapacity:
（4）硬盘缓存的位置：沙盒/Library/Caches
（5）取得某个请求的缓存- (NSCachedURLResponse *)cachedResponseForRequest:
（6）清除某个请求的缓存- (void)removeCachedResponseForRequest:
（7）清除所有的缓存- (void)removeAllCachedResponses;
</code></pre>
</div>

<p>2、缓存</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
    // 1.创建请求
    NSURL *url = [NSURL URLWithString:@"GET"];
    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
    request.cachePolicy = NSURLRequestReturnCacheDataElseLoad;
    
    // 2.根据request检测缓存  
    NSURLCache *cache = [NSURLCache sharedURLCache];
    NSCachedURLResponse *response = [cache cachedResponseForRequest:request];
    if (response) {
        NSLog(@"已经有缓存:%@",response.data);
        // 判断时间，超时就移除缓存
    } else {
        NSLog(@"暂无缓存,开启请求");
        [NSURLConnection sendAsynchronousRequest:request queue:[NSOperationQueue mainQueue] completionHandler:^(NSURLResponse *response, NSData *data, NSError *connectionError) {
         if (data) {
            NSDictionary *dict = [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableLeaves error:nil];
             NSLog(@"%@", dict);
         }
    }];
    }
    
    
</code></pre>
</div>

<h4 id="post-">3、进阶：POST 缓存</h4>

<p>POST 实现缓存需要自己手动实现，如下解说：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
// 读取缓存
+ (id)getCacheResponseWithURL:(NSString *)url params:(NSDictionary *)params {
    id cacheData = nil;
    if (url) {
        // 指定目录
        NSString *directoryPath = DIRECTORYPATH;
        // url+param确定唯一路径
        NSString *originString = [NSString stringWithFormat:@"%@+%@",url,params];

        NSString *path = [directoryPath stringByAppendingPathComponent:[self md5:originString]];
        NSData *data = [[NSFileManager defaultManager] contentsAtPath:path];
        if (data) {
            cacheData = [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableContainers error:nil];
        }
    }
    return cacheData;
}
// 写入缓存
+ (void)cacheResponseObject:(id)responseObject request:(NSURLRequest *)request params:(NSDictionary *)params {
    if (request &amp;&amp; responseObject &amp;&amp; ![responseObject isKindOfClass:[NSNull class]]) {
        NSString *directoryPath = DIRECTORYPATH;
        NSError *error = nil;
        if (![[NSFileManager defaultManager] fileExistsAtPath:directoryPath isDirectory:nil]) {
            [[NSFileManager defaultManager] createDirectoryAtPath:directoryPath
                                      withIntermediateDirectories:YES
                                                       attributes:nil
                                                            error:&amp;error];
        }

        NSString *originString = [NSString stringWithFormat:@"%@+%@",request.URL.absoluteString,params];

        NSString *path = [directoryPath stringByAppendingPathComponent:[self md5:originString]];
        NSDictionary *dict = (NSDictionary *)responseObject;

        NSData *data = nil;
        if ([dict isKindOfClass:[NSData class]]) {
            data = responseObject;
        } else {
            data = [NSJSONSerialization dataWithJSONObject:dict
                                                   options:NSJSONWritingPrettyPrinted
                                                     error:&amp;error];
        }
        if (data &amp;&amp; error == nil) {
            [[NSFileManager defaultManager] createFileAtPath:path contents:data attributes:nil];
        }
    }
}
// 加密
+ (NSString *)md5:(NSString *)string {
    if (string == nil || [string length] == 0) {
        return nil;
    }
    unsigned char digest[CC_MD5_DIGEST_LENGTH], i;
    CC_MD5([string UTF8String], (int)[string lengthOfBytesUsingEncoding:NSUTF8StringEncoding], digest);
    NSMutableString *ms = [NSMutableString string];

    for (i = 0; i &lt; CC_MD5_DIGEST_LENGTH; i++) {
        [ms appendFormat:@"%02x", (int)(digest[i])];
    }

    return [ms copy];
}
</code></pre>
</div>

<h4 id="nsurlcache">4、进阶：自定义缓存策略的NSURLCache</h4>

<p>思路如下：</p>

<ul>
  <li>1、网络请求开始时，首先会判断沙盒中是否存在缓存数据；[没有直接请求]</li>
  <li>2、如果有，判断是否过期；没过期则使用本地数据。[过期则删除缓存，直接请求]</li>
  <li>3、请求URL
代码如下：</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>
// 判断是否为GET
-(NSCachedURLResponse *)cachedResponseForRequest:(NSURLRequest*)request{
    if ([request.HTTPMethod compare:@"GET"] != NSOrderedSame) {
        return [super cachedResponseForRequest:request];
    }
    return [self customResponseForRequest:request];
}

// 加密
-(NSString *)getFileName:(NSString *)url{
    return [url getMd5_32Bit];
}

-(NSString *)getOtherInfoName:(NSString *)url{
    return [[NSString stringWithFormat:@"%@-otherInfo",url] getMd5_32Bit];
}
- (NSString *)cacheFilePath:(NSString *)fileName{
    NSString *filePath = [NSString stringWithFormat:@"URLCache/%@",fileName];
    NSString *path = kFilePathAtCachWithName(filePath);
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDir;
    if([fileManager fileExistsAtPath:path isDirectory:&amp;isDir] &amp;&amp; isDir) {
    } else{
         [fileManager createDirectoryAtPath:path withIntermediateDirectories:YES attributes:nil error:nil];
    }
    return path;
}

-(NSCachedURLResponse*)customResponseForRequest:(NSURLRequest*)request{
    ​NSString *url = request.URL.absoluteString;//请求的链接
    
    // URL MD5 后作为缓存文件名。这里取出MD5后的文件名
    NSString*fileName = [self getFileName:url];
    // 缓存信息的文件名 @"%@-otherInfo",url
    NSString*otherInfoName = [self getOtherInfoName:url];
    // 创建/获取 缓存的目录路径
    NSString*filePath = [self cacheFilePath:fileName];
    // 缓存信息字典路径
    NSString*otherInfoPath = [self cacheFilePath:otherInfoName];
    
    ​NSFileManager *fileManger = [NSFileManager defaultManager];
    //当文件存在的时候
    if ([fileManger fileExistsAtPath:filePath]) {
        NSDate*date = [NSDate date];
        BOOL isOverdue = YES;
        NSDictionary *dicInfo = [NSDictionary dictionaryWithContentsOfFile:otherInfoPath];
        // 过期与否？
        if(self.catchTime &gt; 0 &amp;&amp; dicInfo) {
            NSDate*createDate = dicInfo[kTimeKey];
            double createTime = [date timeIntervalSinceDate:createDate];
            if (createTime &lt; self.catchTime) {
                isOverdue = NO;
        }}
        //没有过期 加载缓存数据
        if (!isOverdue) {
            NSLog(@"访问缓存数据..");
            NSData *data = [NSData dataWithContentsOfFile:filePath];
            NSURLResponse *response = [[NSURLResponse alloc] initWithURL:request.URL MIMEType:dicInfo[kMIMETypeKey] expectedContentLength:data.lengthtextEncodingName:dicInfo[kTextEncodingNameKey]];
            NSCachedURLResponse *cacheResponse = [[NSCachedURLResponsealloc] initWithResponse:response data:data];
            return cacheResponse;
            
        }else{//已经过期，删除数据
            [fileManger removeItemAtPath :filePath error:nil];
            [fileManger removeItemAtPath :otherInfoPath error:nil];
        }
    }
    
    BOOL isExsit = [[self.dicResponse objectForKey:url] boolValue];
    if (!isExsit) {
        [self .dicResponse setObject:@(YES) forKey:url];
        NSLog(@"网络请求数据...");
        __block NSCachedURLResponse *cacheResponse = nil;
        [NSURLConnection sendAsynchronousRequest:request queue:[[NSOperationQueue alloc] init] completionHandler:^(NSURLResponse*response, NSData *data, NSError *connectionError) {
            //移除请求记录
            [self.dicResponse removeObjectForKey:url];
            if (data &amp;&amp; response) {
                NSMutableDictionary *dicInfo = [NSMutableDictionarydictionary];
                [dicInfo setObject :[NSDate date] forKey:kTimeKey];
                [dicInfo setObject :kUnNilStr(response.MIMEType) forKey:kMIMETypeKey];
                [dicInfo setObject :kUnNilStr(response.textEncodingName) forKey:kTextEncodingNameKey];
                BOOL state = [data writeToFile:filePath atomically:NO];
                NSLog(@"%d",state);
                [dicInfo writeToFile :otherInfoPath atomically:YES];
                cacheResponse = [[NSCachedURLResponse alloc] initWithResponse:response data:data];
            }
        }];
        return cacheResponse;
    }else{
        NSLog(@"该请求已存在");
    }
    return nil;
    
}

</code></pre>
</div>
<h2 id="section-2">进阶篇</h2>

<h4 id="useprotocolcachepolicy---">1、UseProtocolCachePolicy - 默认缓存的机制</h4>

<p>1、首先从apple提供的一个缓存策略的枚举说起：</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
typedef NS_ENUM(NSUInteger, NSURLRequestCachePolicy)
{
    // 默认值：按照HTTP协议进行缓存
    NSURLRequestUseProtocolCachePolicy = 0, 
    // 非缓存模式：不使用缓存数据，无论是否有本地缓存
    NSURLRequestReloadIgnoringLocalCacheData = 1,
    // 缓存模式：无论缓存是否过期都是用缓存，没有缓存就进行网络请求
    NSURLRequestReturnCacheDataElseLoad = 2,
    // 离线模式：无论缓存是否过期都是用缓存，没有缓存也不会进行网络请求
    NSURLRequestReturnCacheDataDontLoad = 3,

    NSURLRequestReloadIgnoringCacheData = NSURLRequestReloadIgnoringLocalCacheData,
    NSURLRequestReloadIgnoringLocalAndRemoteCacheData = 4, // Unimplemented
    NSURLRequestReloadRevalidatingCacheData = 5, // Unimplemented
};
</code></pre>
</div>
<p>这个枚举大家应该很熟悉，创建request时经常用到的。这里我进行了分类，主要是4类。其余3个排除。这里除了默认值，其他3个模式都很容易理解，下面以QQ空间的web页面拦截为例说明默认值是如何实现的：</p>

<p>2、拦截QQ WebView的请求
首先在webview上加载QQ空间页面，然后拦截webview上QQ空间登录的response，部分Header字段如下：</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
HTTP/1.1 200 OK
Content-Type    application/x-javascript
Server  QZHTTP-2.38.20
Content-Encoding    gzip
Cache-Control   public; max-age=86400
Proxy-Connection    Keep-alive
</code></pre>
</div>
<p>注意：这里的Cache-Control是我们的目标字段。</p>

<p>3、Cache-Control</p>

<p>这个字段用于指定该次整个请求中的缓存机制。常见的取值有public、private、no-cache、max-age、must-revalidate等，默认为private。QQ空间的Cache-Control解读如下：</p>

<ul>
  <li>public : 所有内容都将被缓存(客户端和代理服务器都可缓存)；</li>
  <li>max-age=86400 : 缓存的内容将在86400秒后失效, 这个选项只在HTTP 1.1可用。</li>
</ul>

<p>4、Cache位置</p>

<p>对于webview而言，缓存的数据默认在Library/Caches里。如下所示(ssh连接iphone)</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
# ls
Documents/  Library/  tmp/
# cd Library/ &amp;&amp; ls
2222/  Caches/  Cookies/  Preferences/  WebKit/
# cd Caches/ &amp;&amp; ls

Databases.db                         http_ui.ptlogin2.qq.com_0.localstorage
Snapshots/                           https_auth.alipay.com_0.localstorage
com.apple.WebKit.Networking/         https_passport.jd.com_0/
com.apple.WebKit.WebContent/         https_passport.jd.com_0.localstorage
http_h5.m.taobao.com_0.localstorage  
[截取部分缓存数据]
</code></pre>
</div>

<p>那在app收到response之后，会根据Cache-Control字段，选择缓存的内容以及缓存的时间，而这些缓存的机制则是由服务器端定义。</p>

<h4 id="section-3">2、缓存高清图片</h4>

<p>经常会见到小图点开之后显示高清图片，那实现的一种方式就是:提前缓存高清图片,功能的实现要基于SDWebImage内部缓存的相关接口。</p>

<p>操作如下：拦截response，然后以url为key，数据为value，先缓存起来，在查看大图的时候，直接加载缓存的图片
代码如下：</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
- (void)storeCachedResponse:(NSCachedURLResponse *)cachedResponse forRequest:(NSURLRequest *)request {
    [super storeCachedResponse:cachedResponse forRequest:request];
    NSString *mimeType = cachedResponse.response.MIMEType;

    if ([mimeType hasPrefix:@"image"]) {
        NSString *url = request.URL.absoluteString;
        NSLog(@"cache url:%@", url);

        SDImageCache *cache = [SDImageCache sharedImageCache];
        [cache storeImage:[UIImage imageWithData:cachedResponse.data] forKey:url toDisk:NO];
    }

}
</code></pre>
</div>
<p>但是注意，这种方法需要URL固定，如果Referer到其他站就会有问题了。</p>

<p>最佳的方案是使用NSURLProtocol解决。详细的可以参考我的NSURLProtocol博文。
如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
- (void)startLoading {
    NSURLSession *session = [NSURLSession sharedSession];
    NSMutableURLRequest *request = [self.request mutableCopy];
    [NSURLProtocol setProperty:@(YES) forKey:kProtocolHandledKey inRequest:request];
    __weak typeof(self) weakSelf = self;
    self.sessionTask = [session dataTaskWithRequest:request completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
        if (error) {
            return;
        }
        NSString *mimeType = response.MIMEType;
        if ([mimeType hasPrefix:@"image"]) {
            NSString *url = weakSelf.request.URL.absoluteString;
            SDImageCache *cache = [SDImageCache sharedImageCache];
            [cache storeImage:[UIImage imageWithData:data] forKey:url toDisk:NO];
        }
        [weakSelf.client URLProtocol:weakSelf didReceiveResponse:response cacheStoragePolicy:NSURLCacheStorageAllowedInMemoryOnly];
        [weakSelf.client URLProtocol:weakSelf didLoadData:data];
        [weakSelf.client URLProtocolDidFinishLoading:weakSelf];
    }];
    [self.task resume];
}
- (void)stopLoading {
    [self.sessionTask cancel];
    self.sessionTask = nil;
}

</code></pre>
</div>

<p>我们使用了自定义的NSURLProtocol对所有http(s)请求进行了拦截，并在资源加载完成的时候进行对mime-type的判断，如果是image，那我们就以请求的URL为key，把请求得到的数据转换为UIImage存入SDImageCache中。</p>


                </div>
                <div class="read-all">
                    <a  href="/2015/10/15/NSURLCache/"><i class="fa fa-newspaper-o"></i>Read All</a>
                </div>
                <hr>
              </li>
            
              <li>
                <h2>
                  <a class="post-link" href="/2015/10/15/NSURLProtocol/">NSURLProtocol小教程</a>
                </h2>
                <div class="label">
                    <div class="label-card">
                        <i class="fa fa-calendar"></i>2015-10-15
                    </div>
                    <div class="label-card">
                        <i class="fa fa-user"></i>3行代码
                        
                    </div>
                    <div class="label-card">
                        
                    </div>

                    <div class="label-card">
                    


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#NSURLProtocol" title="Category: NSURLProtocol" rel="category">NSURLProtocol</a>&nbsp;
    
        <a href="/category/#缓存" title="Category: 缓存" rel="category">缓存</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


                    </div>

                    <div class="label-card">
                    
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <a href="/tag/#NSURLProtocol" title="Tag: NSURLProtocol" rel="tag">NSURLProtocol</a>&nbsp;
    
        <a href="/tag/#缓存" title="Tag: 缓存" rel="tag">缓存</a>
    
  

</span>

                    </div>
                </div>
                <div class="excerpt">
                    <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">1、基本使用</a>    <ul>
      <li><a href="#section-1" id="markdown-toc-section-1">1、注册</a></li>
      <li><a href="#section-2" id="markdown-toc-section-2">2、实现方法</a></li>
      <li><a href="#section-3" id="markdown-toc-section-3">3、坑</a></li>
      <li><a href="#request" id="markdown-toc-request">4、修改request请求头</a></li>
      <li><a href="#requesturl" id="markdown-toc-requesturl">5、request.URL重定向</a></li>
      <li><a href="#nsurlprotocolclient" id="markdown-toc-nsurlprotocolclient">6、NSURLProtocolClient</a></li>
    </ul>
  </li>
  <li><a href="#nsurlprotocolnsurlsession" id="markdown-toc-nsurlprotocolnsurlsession">2、NSURLProtocol拦截NSURLSession</a></li>
</ul>

<p>iOS里面总有一些比较神秘，但也总是充满惊喜的API，譬如本博客持续更新的:NSURLProtocol。</p>

<p>NSURLProtocol并不是protocol而是一个虚拟类。使用的话需要实例化一个子类来操作，在这个子类中，可以实现如下的功能:</p>

<ul>
  <li>重定向网络请求</li>
  <li>忽略网络请求，使用本地缓存</li>
  <li>自定义网络请求的返回结果</li>
  <li>全局的网络请求设置</li>
</ul>

<p>注意:</p>
<ul>
  <li>NSURLProtocol只能拦截 NSURLConnection、NSURLSession 和 UIWebView 中的请求，无法拦截WKWebView中发出的网络请求。</li>
  <li>可以注册多个NSURLProtocol的子类，注册多个NSURLProtocol子类会逆序去执行，也就是先注册的子类后执行。</li>
  <li>AFN\SDWebImage等开始使用NSURLSession，需要注意其中潜在的坑</li>
  <li>UIWebView本身是有缓存的，基于NSURLCache来实现</li>
</ul>

<p>如下是URL Loading System的组织图，本文只是简单的介绍下NSURLProtocol。</p>

<p><img src="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/URLLoadingSystem/Art/nsobject_hierarchy_2x.png" alt="" /></p>

<h2 id="section">1、基本使用</h2>

<h4 id="section-1">1、注册</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">-</span> <span class="o">(</span><span class="n">BOOL</span><span class="o">)</span><span class="nl">application:</span><span class="o">(</span><span class="n">UIApplication</span> <span class="o">*)</span><span class="n">application</span> <span class="nl">didFinishLaunchingWithOptions:</span><span class="o">(</span><span class="n">NSDictionary</span> <span class="o">*)</span><span class="n">launchOptions</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">NSURLProtocol</span> <span class="nl">registerClass:</span><span class="o">[</span><span class="n">CodeURLProtocol</span> <span class="kd">class</span><span class="err">]];</span>
    <span class="nc">return</span> <span class="n">YES</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>
<h4 id="section-2">2、实现方法</h4>

<p>// 1、每有一个请求的时候都会调用这个方法，如果返回YES就代表这个request需要被处理，反之就是不需要被处理。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">static</span> <span class="n">NSString</span> <span class="o">*</span> <span class="kd">const</span> <span class="n">protocolKey</span> <span class="o">=</span> <span class="err">@</span><span class="s">"protocolKey"</span><span class="o">;</span>

<span class="o">+</span> <span class="o">(</span><span class="n">BOOL</span><span class="o">)</span><span class="nl">canInitWithRequest:</span><span class="o">(</span><span class="n">NSURLRequest</span> <span class="o">*)</span><span class="n">request</span> <span class="o">{</span>
    <span class="c1">//防止无限循环，因为一个请求在被拦截处理过程中，也会发起一个请求，这样又会走到这里</span>
    <span class="k">if</span> <span class="o">([</span><span class="n">NSURLProtocol</span> <span class="nl">propertyForKey:</span><span class="n">protocolKey</span> <span class="nl">inRequest:</span><span class="n">request</span><span class="o">])</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">NO</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 对https请求做相关处理</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">scheme</span> <span class="o">=</span> <span class="o">[[</span><span class="n">request</span> <span class="n">URL</span><span class="o">]</span> <span class="n">scheme</span><span class="o">];</span>
    <span class="k">if</span> <span class="o">([</span><span class="n">scheme</span> <span class="nl">caseInsensitiveCompare:</span><span class="err">@</span><span class="s">"https"</span><span class="o">]</span> <span class="o">==</span> <span class="n">NSOrderedSame</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">YES</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">NO</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>// 2、这个方法返回request，可以修改request</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">+</span> <span class="o">(</span><span class="n">NSURLRequest</span> <span class="o">*)</span><span class="nl">canonicalRequestForRequest:</span><span class="o">(</span><span class="n">NSURLRequest</span> <span class="o">*)</span><span class="n">request</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>// 3、这个方法用于处理被拦截的request，从而处理请求头、重定向、缓存等</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">startLoading</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre>
</div>

<p>// 4、停止请求</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span> <span class="nx">stopLoading</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre>
</div>
<h4 id="section-3">3、坑</h4>
<p>不做解释，遇到的人都懂：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="o">([</span><span class="n">NSURLProtocol</span> <span class="nl">propertyForKey:</span><span class="n">protocolKey</span> <span class="nl">inRequest:</span><span class="n">request</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">NO</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">[</span><span class="n">NSURLProtocol</span> <span class="nl">setProperty:</span><span class="err">@</span><span class="o">(</span><span class="n">YES</span><span class="o">)</span> <span class="nl">forKey:</span><span class="n">protocolKey</span> <span class="nl">inRequest:</span><span class="n">request</span><span class="o">];</span>
</code></pre>
</div>

<h4 id="request">4、修改request请求头</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">-</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span><span class="n">startLoading</span> <span class="o">{</span>
    <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">request</span> <span class="n">mutableCopy</span><span class="o">];</span>
    <span class="c1">//给请求头添加一个请求体</span>
    <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">headers</span> <span class="o">=</span> <span class="o">[</span><span class="n">request</span><span class="o">.</span><span class="na">allHTTPHeaderFields</span> <span class="n">mutableCopy</span><span class="o">];</span>
    <span class="o">[</span><span class="n">headers</span> <span class="nl">setObject:</span><span class="err">@</span><span class="s">"3code.info"</span> <span class="nl">forKey:</span><span class="err">@</span><span class="s">"key"</span><span class="o">];</span>
    <span class="n">request</span><span class="o">.</span><span class="na">allHTTPHeaderFields</span> <span class="o">=</span> <span class="n">headers</span><span class="o">;</span>
    <span class="o">[</span><span class="n">NSURLProtocol</span> <span class="nl">setProperty:</span><span class="err">@</span><span class="o">(</span><span class="n">YES</span><span class="o">)</span> <span class="nl">forKey:</span><span class="n">protocolKey</span> <span class="nl">inRequest:</span><span class="n">request</span><span class="o">];</span>
    <span class="c1">//.....然后使用NSURLSession发送request</span>
<span class="o">}</span>
</code></pre>
</div>
<h4 id="requesturl">5、request.URL重定向</h4>
<p>将请求重定向到3code.info</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>
<span class="o">-</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span><span class="n">startLoading</span> <span class="o">{</span>
    <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">request</span> <span class="n">mutableCopy</span><span class="o">];</span>
    <span class="c1">//request改为访问3code.info了</span>
    <span class="n">request</span><span class="o">.</span><span class="na">URL</span> <span class="o">=</span> <span class="o">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="err">@</span><span class="s">"http://www.3code.info"</span><span class="o">];</span>
    <span class="o">[</span><span class="n">NSURLProtocol</span> <span class="nl">setProperty:</span><span class="err">@</span><span class="o">(</span><span class="n">YES</span><span class="o">)</span> <span class="nl">forKey:</span><span class="n">protocolKey</span> <span class="nl">inRequest:</span><span class="n">request</span><span class="o">];</span>
    <span class="c1">//使用NSURLSession继续把重定向的request发送出去</span>
    <span class="n">NSURLSessionConfiguration</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">[</span><span class="n">NSURLSessionConfiguration</span> <span class="n">ephemeralSessionConfiguration</span><span class="o">];</span>
    <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">mainQueue</span> <span class="o">=</span> <span class="o">[</span><span class="n">NSOperationQueue</span> <span class="n">mainQueue</span><span class="o">];</span>
    <span class="n">NSURLSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="o">[</span><span class="n">NSURLSession</span> <span class="nl">sessionWithConfiguration:</span><span class="n">config</span> <span class="nl">delegate:</span><span class="n">self</span> <span class="nl">delegateQueue:</span><span class="n">mainQueue</span><span class="o">];</span>
    <span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="o">[</span><span class="n">session</span> <span class="nl">dataTaskWithRequest:</span><span class="n">request</span><span class="o">];</span>
    <span class="o">[</span><span class="n">task</span> <span class="n">resume</span><span class="o">];</span>
<span class="o">}</span>
</code></pre>
</div>
<h4 id="nsurlprotocolclient">6、NSURLProtocolClient</h4>

<p>webview中发送一个request，在这里拦截后使用NSURLSession重新发request。那webview是收不到response的。这里就要做一个处理，每一个NSURLProtocol的子类都有一个client对象来处理response。写法用下边这个就行，比较固定的。(保留了以前的NSURLConnection)</p>

<p>本次更新：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">-(</span><span class="kt">void</span><span class="o">)</span><span class="nl">URLSession:</span><span class="o">(</span><span class="n">NSURLSession</span> <span class="o">*)</span><span class="n">session</span> <span class="nl">task:</span><span class="o">(</span><span class="n">NSURLSessionTask</span> <span class="o">*)</span><span class="n">task</span> <span class="nl">didCompleteWithError:</span><span class="o">(</span><span class="n">NSError</span> <span class="o">*)</span><span class="n">error</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">error</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocol:</span><span class="n">self</span> <span class="nl">didFailWithError:</span><span class="n">error</span><span class="o">];</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocolDidFinishLoading:</span><span class="n">self</span><span class="o">];</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">-(</span><span class="kt">void</span><span class="o">)</span><span class="nl">URLSession:</span><span class="o">(</span><span class="n">NSURLSession</span> <span class="o">*)</span><span class="n">session</span> <span class="nl">dataTask:</span><span class="o">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*)</span><span class="n">dataTask</span> <span class="nl">didReceiveResponse:</span><span class="o">(</span><span class="n">NSURLResponse</span> <span class="o">*)</span><span class="n">response</span> <span class="nl">completionHandler:</span><span class="o">(</span><span class="kt">void</span> <span class="o">(^)(</span><span class="n">NSURLSessionResponseDisposition</span><span class="o">))</span><span class="n">completionHandler</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocol:</span><span class="n">self</span> <span class="nl">didReceiveResponse:</span><span class="n">response</span> <span class="nl">cacheStoragePolicy:</span><span class="n">NSURLCacheStorageNotAllowed</span><span class="o">];</span>
    <span class="n">completionHandler</span><span class="o">(</span><span class="n">NSURLSessionResponseAllow</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">-(</span><span class="kt">void</span><span class="o">)</span><span class="nl">URLSession:</span><span class="o">(</span><span class="n">NSURLSession</span> <span class="o">*)</span><span class="n">session</span> <span class="nl">dataTask:</span><span class="o">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*)</span><span class="n">dataTask</span> <span class="nl">didReceiveData:</span><span class="o">(</span><span class="n">NSData</span> <span class="o">*)</span><span class="n">data</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocol:</span><span class="n">self</span> <span class="nl">didLoadData:</span><span class="n">data</span><span class="o">];</span>
<span class="o">}</span>
<span class="o">-</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span><span class="nl">URLSession:</span><span class="o">(</span><span class="n">NSURLSession</span> <span class="o">*)</span><span class="n">session</span> <span class="nl">dataTask:</span><span class="o">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*)</span><span class="n">dataTask</span> <span class="nl">willCacheResponse:</span><span class="o">(</span><span class="n">NSCachedURLResponse</span> <span class="o">*)</span><span class="n">proposedResponse</span> <span class="nl">completionHandler:</span><span class="o">(</span><span class="kt">void</span> <span class="o">(^)(</span><span class="n">NSCachedURLResponse</span> <span class="o">*</span><span class="n">cachedResponse</span><span class="o">))</span><span class="n">completionHandler</span> <span class="o">{</span>
    <span class="n">completionHandler</span><span class="o">(</span><span class="n">proposedResponse</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>
<p>NSURLConnection：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">-</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span> <span class="nl">connection:</span><span class="o">(</span><span class="n">NSURLConnection</span> <span class="o">*)</span><span class="n">connection</span> <span class="nl">didReceiveResponse:</span><span class="o">(</span><span class="n">NSURLResponse</span> <span class="o">*)</span><span class="n">response</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocol:</span><span class="n">self</span> <span class="nl">didReceiveResponse:</span><span class="n">response</span> <span class="nl">cacheStoragePolicy:</span><span class="n">NSURLCacheStorageNotAllowed</span><span class="o">];</span>
<span class="o">}</span>
<span class="o">-</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span> <span class="nl">connection:</span><span class="o">(</span><span class="n">NSURLConnection</span> <span class="o">*)</span><span class="n">connection</span> <span class="nl">didReceiveData:</span><span class="o">(</span><span class="n">NSData</span> <span class="o">*)</span><span class="n">data</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocol:</span><span class="n">self</span> <span class="nl">didLoadData:</span><span class="n">data</span><span class="o">];</span>
<span class="o">}</span>
<span class="o">-</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span> <span class="nl">connectionDidFinishLoading:</span><span class="o">(</span><span class="n">NSURLConnection</span> <span class="o">*)</span><span class="n">connection</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocolDidFinishLoading:</span><span class="n">self</span><span class="o">];</span>
<span class="o">}</span>
<span class="o">-</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span><span class="nl">connection:</span><span class="o">(</span><span class="n">NSURLConnection</span> <span class="o">*)</span><span class="n">connection</span> <span class="nl">didFailWithError:</span><span class="o">(</span><span class="n">NSError</span> <span class="o">*)</span><span class="n">error</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">self</span><span class="o">.</span><span class="na">client</span> <span class="nl">URLProtocol:</span><span class="n">self</span> <span class="nl">didFailWithError:</span><span class="n">error</span><span class="o">];</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="nsurlprotocolnsurlsession">2、NSURLProtocol拦截NSURLSession</h2>

<p>上一期的项目有个需求，就是在移动网络下，不进行高清图片，视频等下载操作。其中遇到的问题就是拦截NSURLSession。这里简化为如下实现。</p>

<p>思路：使用NSURLProtocol拦截所有的request，过滤耗流量的request。并做处理。其实蛮简单的，但是AFNetwork、SDWebImageCache等三方库并未拦截。原因是NSURLSession。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>
<span class="o">+</span> <span class="o">(</span><span class="n">BOOL</span><span class="o">)</span><span class="nl">canInitWithRequest:</span><span class="o">(</span><span class="n">NSURLRequest</span> <span class="o">*)</span><span class="n">request</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">([</span><span class="n">NSURLProtocol</span> <span class="nl">propertyForKey:</span><span class="n">protocolKey</span> <span class="nl">inRequest:</span><span class="n">request</span><span class="o">])</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">NO</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//满足条件时直接截获请求</span>
    <span class="k">if</span> <span class="o">([[</span><span class="n">UserConfig</span> <span class="n">sharedInstance</span><span class="o">]</span> <span class="n">isOffPicture</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">([</span><span class="n">request</span><span class="o">.</span><span class="na">URL</span><span class="o">.</span><span class="na">pathExtension</span> <span class="nl">caseInsensitiveCompare:</span><span class="err">@</span><span class="s">"jpg"</span><span class="o">]</span> <span class="o">==</span> <span class="n">NSOrderedSame</span> <span class="o">||</span> <span class="o">[</span><span class="n">request</span><span class="o">.</span><span class="na">URL</span><span class="o">.</span><span class="na">pathExtension</span> <span class="nl">caseInsensitiveCompare:</span><span class="err">@</span><span class="s">"png"</span><span class="o">]</span> <span class="o">==</span> <span class="n">NSOrderedSame</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">[</span><span class="n">self</span> <span class="n">isPictureDownload</span><span class="o">])</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">YES</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">NO</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>从官方文档中可以了解到自定义的NSURLProtocol子类需要赋给NSURLSessionConfiguration的protocolClasses属性,同时其创建的Session时关联的NSURLSessionConfiguration为defaultSessionConfiguration。那么解决方法就跃然纸上了，如下代码：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">+</span> <span class="o">(</span><span class="n">NSURLSessionConfiguration</span> <span class="o">*)</span><span class="n">zw_defaultSessionConfiguration</span> <span class="o">{</span>
<span class="c1">//    如果需要NSURLProtocol来截获NSURLSession发出的请求，需要每一个NSURLSession在创建时配置的NSURLSessionConfiguration类的protocolClasses属性附上自定义的NSURLProtocol：如下</span>
    <span class="n">NSURLSessionConfiguration</span> <span class="o">*</span><span class="n">configuration</span> <span class="o">=</span> <span class="o">[</span><span class="n">self</span> <span class="n">zw_defaultSessionConfiguration</span><span class="o">];</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">protocolClasses</span> <span class="o">=</span> <span class="err">@</span><span class="o">[[</span><span class="n">CodeURLProtocol</span> <span class="kd">class</span><span class="err">]];</span>
    <span class="nc">configuration</span><span class="o">.</span><span class="na">protocolClasses</span> <span class="o">=</span> <span class="n">protocolClasses</span><span class="o">;</span>
    
    <span class="k">return</span> <span class="n">configuration</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">+</span> <span class="o">(</span><span class="kt">void</span><span class="o">)</span><span class="n">load</span> <span class="o">{</span>
<span class="c1">//  使用Method Swizzling方法，defaultSessionConfiguration实现（AFNetwork、SDWebImageCache在创建时使用的是[NSURLSessionConfiguration defaultSessionConfiguration]）如下：</span>
    <span class="n">Method</span> <span class="n">systemMethod</span> <span class="o">=</span> <span class="n">class_getClassMethod</span><span class="o">([</span><span class="n">NSURLSessionConfiguration</span> <span class="kd">class</span><span class="err">],</span> <span class="err">@</span><span class="nc">selector</span><span class="o">(</span><span class="n">defaultSessionConfiguration</span><span class="o">));</span>
    <span class="n">Method</span> <span class="n">zwMethod</span> <span class="o">=</span> <span class="n">class_getClassMethod</span><span class="o">([</span><span class="n">self</span> <span class="kd">class</span><span class="err">],</span> <span class="err">@</span><span class="nc">selector</span><span class="o">(</span><span class="n">zw_defaultSessionConfiguration</span><span class="o">));</span>
    <span class="n">method_exchangeImplementations</span><span class="o">(</span><span class="n">systemMethod</span><span class="o">,</span> <span class="n">zwMethod</span><span class="o">);</span>
    <span class="o">[</span><span class="n">NSURLProtocol</span> <span class="nl">registerClass:</span><span class="o">[</span><span class="n">CodeURLProtocol</span> <span class="kd">class</span><span class="err">]];</span>
<span class="err">}</span>
</code></pre>
</div>

<p>以上就解决了NSURLProtocol拦截NSURLSession的问题。</p>


                </div>
                <div class="read-all">
                    <a  href="/2015/10/15/NSURLProtocol/"><i class="fa fa-newspaper-o"></i>Read All</a>
                </div>
                <hr>
              </li>
            
              <li>
                <h2>
                  <a class="post-link" href="/2015/08/07/REVERSE4_Reveal/">IOS逆向系列_Reveal_解码任意APP的UI界面</a>
                </h2>
                <div class="label">
                    <div class="label-card">
                        <i class="fa fa-calendar"></i>2015-08-07
                    </div>
                    <div class="label-card">
                        <i class="fa fa-user"></i>3行代码
                        
                    </div>
                    <div class="label-card">
                        
                    </div>

                    <div class="label-card">
                    


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#IOS逆向" title="Category: IOS逆向" rel="category">IOS逆向</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


                    </div>

                    <div class="label-card">
                    
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <a href="/tag/#Reveal" title="Tag: Reveal" rel="tag">Reveal</a>&nbsp;
    
        <a href="/tag/#iOSOpenDev" title="Tag: iOSOpenDev" rel="tag">iOSOpenDev</a>
    
  

</span>

                    </div>
                </div>
                <div class="excerpt">
                    <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">前言</a></li>
  <li><a href="#iphone" id="markdown-toc-iphone">iphone配置</a>    <ul>
      <li><a href="#revealloader" id="markdown-toc-revealloader">RevealLoader</a></li>
    </ul>
  </li>
  <li><a href="#mac" id="markdown-toc-mac">Mac配置</a>    <ul>
      <li><a href="#ssh" id="markdown-toc-ssh">1、SSH</a></li>
      <li><a href="#section-1" id="markdown-toc-section-1">2、关于破解：</a></li>
      <li><a href="#reveal" id="markdown-toc-reveal">3、Reveal</a></li>
      <li><a href="#framework---dylib--plist" id="markdown-toc-framework---dylib--plist">4、framework +  dylib + plist</a>        <ul>
          <li><a href="#revealserverframework" id="markdown-toc-revealserverframework">4.1  RevealServer.framework</a></li>
          <li><a href="#librevealdylib" id="markdown-toc-librevealdylib">4.2 libReveal.dylib</a>            <ul>
              <li><a href="#iosopendev" id="markdown-toc-iosopendev">方法1：iOSOpenDev创建一个</a></li>
              <li><a href="#section-2" id="markdown-toc-section-2">方法2</a></li>
            </ul>
          </li>
          <li><a href="#librevealplist" id="markdown-toc-librevealplist">4.3 libReveal.plist</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="section">前言</h2>

<p>Reveal可以直观地查看App的UI布局，官方给Reveal的定位是“See your application’s view hierarchy at runtime with advanced 2D and 3D visualisations”，但作为逆向开发，查看自己App的UI布局显然不能满足我们的需求，能够查看别人App的UI布局才是正经事儿。</p>

<p>从使用至今，Reveal也历经了好几个版本：1.5.x-&gt;1.6.x-&gt;V++(V2等)，不论是哪个版本都有免费使用的机会。旧版的可以直接破解，新版的可以修改系统时间来解决。</p>

<h2 id="iphone">iphone配置</h2>

<h3 id="revealloader">RevealLoader</h3>

<p>1、在手机上添加源:http://rheard.com/cydia然后安装 Reveal Loader。注意需要VPN才行。</p>

<p>2、下载完Reveal Loader后，检查iOS上的/Library/目录下有没有一个名为RHRevealLoader的文件夹:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># ls -l /Library/ | grep RHRevealLoader
</code></pre>
</div>

<p>如果没有，就手动创建一个:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># mkdir /Library/RHRevealLoader
</code></pre>
</div>

<p>3、Reveal Loader的配置界面位于Settings应用中，点击Reveal进入其界面，呈现在我们面前的主要是一些使用声明。点击Enabled Applications，进入配置界面。要分析哪个App，就打开对应的开关。</p>

<h2 id="mac">Mac配置</h2>

<h3 id="ssh">1、SSH</h3>

<p>手动开启，或者使用PP助手，没有使用过的话，<strong>记得开启后修改密码。</strong></p>

<h3 id="section-1">2、关于破解：</h3>

<p>如果是使用1.6.x以下的版本，可以google到破解文件，覆盖安装就行。
如果是V2及以上版本，破解方法我还没找，现在用的是1.5.x。。</p>

<p>注意：新版的Reveal缺少libReaveal.dylib，可以基于Reveal.framwwork使用iOSOpenDev创建一个。</p>

<h3 id="reveal">3、Reveal</h3>

<p>与其功能相近的工具有：PonyDebugger（https://github.com/square/PonyDebugger）和Spark Inspector（http://sparkinspector.com）。不过Reveal在UI上更直观些。</p>

<p>其常规用法是将framework集成至Xcode工程中，具体可参见Reveal的官网<a href="http://revealapp.com/">http://revealapp.com/</a>，</p>

<p>下面进重点。</p>

<h3 id="framework---dylib--plist">4、framework +  dylib + plist</h3>

<h4 id="revealserverframework">4.1  RevealServer.framework</h4>
<p>通过openSSH拷贝framework到越狱机</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scp -r /Applications/Reveal.app/Contents/SharedSupport/iOS-Libraries/RevealServer.framework root@iphoneip:/System/Library/Frameworks  
</code></pre>
</div>

<p>早期版本的libReveal.dylib是支持ARM架构的，只要把这个libReveal.dylib文件扔到手机的/Library/MobileSubstrate/DynamicLibraries/目录下，就OK了：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scp /Applications/Reveal.app/Contents/SharedSupport/iOS-Libraries/libReveal.dylib root@iphoneip:/Library/MobileSubstrate/DynamicLibraries  
</code></pre>
</div>

<h4 id="librevealdylib">4.2 libReveal.dylib</h4>

<p>然后打开Reveal，在它标题栏的Help选项下，点开Show Reveal Library in Finder,把libReveal.dylib拷贝到RHRevealLoader目录下。</p>

<p>新版的这个文件是没有的，麻烦点可以使用iOSOpenDev创建：</p>

<h6 id="iosopendev">方法1：iOSOpenDev创建一个</h6>

<ul>
  <li>1、安装 macports</li>
  <li>2、 已经安装可能要升级,更新MacPorts到最新版本，时间比较长。 $sudo port -v selfupdate</li>
  <li>3、更新MacPorts后，安装DPKG文件，装过的忽略。 $ sudo port -f install dpkg</li>
  <li>4、安装iOSOpenDev <a href="http://iosopendev.com/download/">http://iosopendev.com/download/</a></li>
  <li>5、期间会各种报错，可以google解决。</li>
  <li>6、新建CaptainHookTweak工程，使用Reveal.framwwork生成一个libReaveal.dylib即可。
注意一定要添加相关的库，否则编译会报错。</li>
</ul>

<h6 id="section-2">方法2</h6>

<p>注意，还有简单的方法😁😁😁</p>

<p>将文件/Applications/Reveal.app/Contents/SharedSupport/iOS-Libraries/RevealServer.framework/RevealServer 重命名为libReveal.dylib。copy到手机目录下：/Library/MobileSubstrate/DynamicLibraries/即可</p>

<h4 id="librevealplist">4.3 libReveal.plist</h4>

<p>在电脑上创建libReveal.plist，然后copy到iphone的 /Library/MobileSubstrate/DynamicLibraries/ 目录下。</p>

<p>libReveal.plist内容如下（Bundles里写要分析的app的Bundle，可以制定多个):</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">     
    </span><span class="err">Filter</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">{</span><span class="w">    
         </span><span class="err">Bundles</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">(</span><span class="nt">"info.3code.www"</span><span class="err">);</span><span class="w">     
    </span><span class="err">};</span><span class="w">     
</span><span class="err">}</span><span class="w">  
</span></code></pre>
</div>

<p><strong>注意：</strong></p>

<p>0、只有安装 Cydia Substrate之后才会有MobileSubstrate目录。mobilesubstrate是cydia插件/软件运行的一个基础依赖包。它提供软件运行的公共库，可以用来动态替换内存中的代码、数据等。安装的插件或软件比如iFile、Activator、SBSettings几乎都是依赖mobilesubstrate才能运行的。</p>

<p>1、libReveal.plist：这个plist是有过滤作用的，它决定你要研究那个App，你通过指定bundleId来决定哪个App/进程启动时，这个libReveal.dylib注入进去。当libReveal.plist不存在时，相当于没有过滤，没有限制，所有进程都会被注入，可能出现白苹果，修复方法见google…</p>

<p>2、手机的/Library/MobileSubstrate/DynamicLibraries目录下存放着所有在系统启动时就需要加载的动态链接库，所以把reveal的动态链接库上传</p>

<p>以上完成之后：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># killall SpringBoard
或者手动重启
</code></pre>
</div>

<p>然后 开启Reveal，就可以尽情的分析APP喽。</p>

<p>链接：
<a href="https://github.com/heardrwt/RevealLoader">https://github.com/heardrwt/RevealLoader</a></p>


                </div>
                <div class="read-all">
                    <a  href="/2015/08/07/REVERSE4_Reveal/"><i class="fa fa-newspaper-o"></i>Read All</a>
                </div>
                <hr>
              </li>
            
              <li>
                <h2>
                  <a class="post-link" href="/2015/08/07/REVERSE4_Charles/">IOS逆向系列_Charles_iPhone网络抓包</a>
                </h2>
                <div class="label">
                    <div class="label-card">
                        <i class="fa fa-calendar"></i>2015-08-07
                    </div>
                    <div class="label-card">
                        <i class="fa fa-user"></i>3行代码
                        
                    </div>
                    <div class="label-card">
                        
                    </div>

                    <div class="label-card">
                    


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#IOS逆向" title="Category: IOS逆向" rel="category">IOS逆向</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


                    </div>

                    <div class="label-card">
                    
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <a href="/tag/#Charles" title="Tag: Charles" rel="tag">Charles</a>
    
  

</span>

                    </div>
                </div>
                <div class="excerpt">
                    <ul id="markdown-toc">
  <li><a href="#charles" id="markdown-toc-charles">安装Charles</a></li>
  <li><a href="#section" id="markdown-toc-section">配置</a>    <ul>
      <li><a href="#section-1" id="markdown-toc-section-1">1、配置代理：</a></li>
      <li><a href="#section-2" id="markdown-toc-section-2">2、配置手机：</a></li>
      <li><a href="#https" id="markdown-toc-https">3、拦截HTTPS配置：</a></li>
      <li><a href="#section-3" id="markdown-toc-section-3">4、手机安装证书：</a></li>
      <li><a href="#ssl-proxy" id="markdown-toc-ssl-proxy">5、对于手机上某个请求的网址，右键选择激活SSL proxy</a></li>
      <li><a href="#section-4" id="markdown-toc-section-4">6、模拟慢网速</a></li>
    </ul>
  </li>
</ul>

<h2 id="charles">安装Charles</h2>

<p>官网下载：<a href="https://www.charlesproxy.com/">https://www.charlesproxy.com/</a></p>

<p>从网上找到最新的破解文件：charles.jar，替换系统的即可破解</p>

<h2 id="section">配置</h2>

<h4 id="section-1">1、配置代理：</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>Proxy-&gt;Proxy Settings 设置端口8888，勾选Enable transparent HTTP proxying
</code></pre>
</div>

<h4 id="section-2">2、配置手机：</h4>
<p>查看电脑IP(Help-&gt;Local IP Address)，然后iPhone上也设置相同的IP(在无线局域网-&gt;当前连接的wifi-&gt;详情-&gt;最底部HTTP 代理-&gt;手动-&gt;填上电脑的IP、端口号8888)</p>

<h4 id="https">3、拦截HTTPS配置：</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>HELP-&gt; SSL Proxying-&gt;ICRC 安装证书 
</code></pre>
</div>

<h4 id="section-3">4、手机安装证书：</h4>

<div class="highlighter-rouge"><pre class="highlight"><code> Help -&gt; SSL Proxying -&gt; Install Charles Root Certificate on a Mobile Device or Remote Browser
</code></pre>
</div>

<p>在手机浏览器中访问地址：http://charlesproxy.com/getssl，即可打开证书安装的界面，安装完证书后，就可以截取手机上的Https通讯内容了</p>

<h4 id="ssl-proxy">5、对于手机上某个请求的网址，右键选择激活SSL proxy</h4>

<h4 id="section-4">6、模拟慢网速</h4>
<p>proxy–&gt;throttle setting —&gt;enable throttling 即可，这个页面就是设置网络节流的</p>


                </div>
                <div class="read-all">
                    <a  href="/2015/08/07/REVERSE4_Charles/"><i class="fa fa-newspaper-o"></i>Read All</a>
                </div>
                <hr>
              </li>
            
              <li>
                <h2>
                  <a class="post-link" href="/2015/06/10/WKWebView/">WKWebView小教程</a>
                </h2>
                <div class="label">
                    <div class="label-card">
                        <i class="fa fa-calendar"></i>2015-06-10
                    </div>
                    <div class="label-card">
                        <i class="fa fa-user"></i>3行代码
                        
                    </div>
                    <div class="label-card">
                        
                    </div>

                    <div class="label-card">
                    


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#WKWebView" title="Category: WKWebView" rel="category">WKWebView</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


                    </div>

                    <div class="label-card">
                    
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <a href="/tag/#WKWebView、Native与JS、缓存、NSURLProtocol" title="Tag: WKWebView、Native与JS、缓存、NSURLProtocol" rel="tag">WKWebView、Native与JS、缓存、NSURLProtocol</a>
    
  

</span>

                    </div>
                </div>
                <div class="excerpt">
                    <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">前言</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">1、基础</a>    <ul>
      <li><a href="#section-2" id="markdown-toc-section-2">1.1 初始化</a></li>
      <li><a href="#section-3" id="markdown-toc-section-3">1.2 加载页面</a></li>
      <li><a href="#section-4" id="markdown-toc-section-4">1.3 代理方法</a>        <ul>
          <li><a href="#section-5" id="markdown-toc-section-5">1.3.1  需要注意的几个代理方法：</a></li>
          <li><a href="#section-6" id="markdown-toc-section-6">1.3.2 其它代理方法汇总</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="section">前言</h2>

<p>WKWebView出来有段时间了，项目中一直在使用UIWebView因为要兼容IOS7，前段时间产品那边忽然想开了，ignoreIOS7。下边总结了之前学习的笔记，如果需要demo的还请留言。
早在2014年的WWDC大会上就了解过WebKit，自诩有60fps刷新率、内置手势、和Safari相同的JavaScript引擎等等众多优势，相比之下UIWebview显得比较low。</p>

<p>就这段时间的使用体验来看，变化集中在：</p>
<ul>
  <li>1、内存消耗少，性能提升；</li>
  <li>2、协议接口更细化，更丰富；</li>
  <li>3、GPU硬件加速、KVO、cookie不自动携带…</li>
</ul>

<p>福利资源：<a href="https://github.com/WebKit/webkit">WebKit源码</a></p>

<h2 id="section-1">1、基础</h2>

<p>基本属性</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="err">#</span><span class="kn">import</span> <span class="err">&lt;</span><span class="nn">WebKit</span><span class="o">/</span><span class="n">WebKit</span><span class="o">.</span><span class="na">h</span><span class="o">&gt;</span>


<span class="n">WKWebView</span> <span class="o">*</span><span class="n">webView</span> <span class="o">=</span> <span class="o">[[</span><span class="n">WKWebView</span> <span class="n">alloc</span><span class="o">]</span> <span class="nl">initWithFrame:</span><span class="n">self</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">frame</span><span class="o">];</span>
<span class="c1">// 代理</span>
<span class="n">webView</span><span class="o">.</span><span class="na">navigationDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="o">;</span>
<span class="n">webView</span><span class="o">.</span><span class="na">UIDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="o">;</span>
<span class="c1">// opaque不透明的。</span>
<span class="n">webView</span><span class="o">.</span><span class="na">opaque</span> <span class="o">=</span> <span class="n">NO</span><span class="o">;</span>  
<span class="c1">// web内手势左右滑动导航</span>
<span class="n">webView</span><span class="o">.</span><span class="na">allowsBackForwardNavigationGestures</span> <span class="o">=</span><span class="n">YES</span><span class="o">;</span>
<span class="c1">// 加载数据</span>
<span class="o">[</span><span class="n">webView</span> <span class="nl">loadRequest:</span><span class="o">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="o">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="err">@</span><span class="s">"http://www.3code.info"</span><span class="o">]]];</span>
</code></pre>
</div>

<h4 id="section-2">1.1 初始化</h4>

<p>初始化方法，两种：</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="c1">// 默认初始化</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">instancetype</span><span class="p">)</span><span class="nx">initWithFrame</span><span class="err">:</span> 
<span class="c1">// 根据对webview的相关配置，进行初始化 【【此种方法参见下方的cookie小节，里面有详细的使用介绍】】</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">instancetype</span><span class="p">)</span><span class="nx">initWithFrame</span><span class="err">:</span> <span class="nx">configuration</span><span class="err">:</span> 

</code></pre>
</div>

<h4 id="section-3">1.2 加载页面</h4>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="c1">// 通过一个网页URL来加载一个WKWebView</span>
<span class="o">-</span><span class="nx">loadRequest</span><span class="err">:</span> 
<span class="c1">// 根据一个文件,加载一个WKWebView，后边是资源路径 【IOS9】</span>
<span class="o">-</span><span class="nx">loadFileURL</span><span class="err">:</span> <span class="nx">allowingReadAccessToURL</span><span class="err">:</span> 
<span class="c1">// 将html文件读取为字符串从而加载为WKWebView，baseURL是我们自己设置的资源路径(主目录)</span>
<span class="o">-</span><span class="nx">loadHTMLString</span><span class="err">:</span> <span class="nx">baseURL</span><span class="err">:</span> 
<span class="c1">// 下边方法使用的比较少，但更加自由，其中data是文件数据，MIMEType是文件类型，characterEncodingName是编码类型，baseURL是素材资源路径</span>
<span class="o">-</span><span class="nx">loadData</span><span class="err">:</span> <span class="nx">MIMEType</span><span class="err">:</span> <span class="nx">characterEncodingName</span><span class="err">:</span>  <span class="nx">baseURL</span><span class="err">:</span>  <span class="nx">NS_AVAILABLE</span><span class="p">(</span><span class="mi">10</span><span class="nx">_11</span><span class="p">,</span> <span class="mi">9</span><span class="nx">_0</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="section-4">1.3 代理方法</h4>

<h5 id="section-5">1.3.1  需要注意的几个代理方法：</h5>

<p>1、<code class="highlighter-rouge">-(void)webView: decidePolicyForNavigationAction: </code></p>

<p>注意的是：</p>
<ul>
  <li>需要call decisionHandler，允许or不允许加载，否则报错。</li>
  <li>
    <p>当点击link时，如果有标签_blank,在webview中不会新开窗口，但是在WKWeb中，可以控制新开一个WKWebview。这时可以通过该方法的第一个参数WKNavigationAction的属性，来判断是否需要开新的view:</p>

    <p>if(!navigationAction.targetFrame.mainFrame){
      开新窗口
  }</p>
  </li>
</ul>

<p>这时就会调用 createWebViewWithConfiguration方法return的wkwebview，来加载新的页面。但如果没有实现这个协议，那么操作link就不会有反应了。</p>

<p>2、<code class="highlighter-rouge">-(void) webView: decidePolicyForNavigationResponse: </code>
这个也需要call decisionHandler,允许or不允许加载。</p>

<h5 id="section-6">1.3.2 其它代理方法汇总</h5>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="cm">/* WKNavigationDelegate  */</span>

<span class="c1">//1、【即将发送request请求】 可以决定是否请求，拦截request、cookie等。call decisionHandler</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">decidePolicyForNavigationAction</span><span class="err">:</span> 
<span class="c1">//2、【开始请求页面】</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">didStartProvisionalNavigation</span><span class="err">:</span> 
<span class="c1">//3、【收到response】 根据response决定要不要继续加载。call decisionHandler</span>
<span class="o">-</span><span class="p">(</span><span class="k">void</span><span class="p">)</span> <span class="nx">webView</span><span class="err">:</span> <span class="nx">decidePolicyForNavigationResponse</span><span class="err">:</span> 
<span class="c1">//4、【收到web内容，开始渲染】 可以注入JS</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">didCommitNavigation</span><span class="err">:</span> 
<span class="c1">//5、【页面渲染完成】可以注入JS</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">didFinishNavigation</span><span class="err">:</span> 

<span class="c1">// 【网页内容被终止】</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webViewWebContentProcessDidTerminate</span><span class="err">:</span>
<span class="c1">// 【错误：页面跳转失败】</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">didFailNavigation</span><span class="err">:</span> 
<span class="c1">// 【错误：启动加载数据失败】</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">didFailProvisionalNavigation</span><span class="err">:</span> 
<span class="c1">// 【页面校验身份】</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">didReceiveAuthenticationChallenge</span><span class="err">:</span> 
<span class="c1">// 【重定向】</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">didReceiveServerRedirectForProvisionalNavigation</span>

<span class="cm">/* UIDelegate  */</span>
<span class="c1">// 当页面中有调用了js的alert、confirm、prompt方法就会触发以下方法</span>
<span class="c1">// 页面中有输入框弹出警告框时调用</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">runJavaScriptTextInputPanelWithPrompt</span><span class="err">:</span> 
<span class="c1">// 页面中有确认框弹出警告框时调用</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">runJavaScriptConfirmPanelWithMessage</span><span class="err">:</span><span class="p">(</span> 
<span class="c1">// 警告框页面中有警告框弹出警告框时调用</span>
<span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="err">:</span> <span class="nx">runJavaScriptAlertPanelWithMessage</span><span class="err">:</span> 
</code></pre>
</div>


                </div>
                <div class="read-all">
                    <a  href="/2015/06/10/WKWebView/"><i class="fa fa-newspaper-o"></i>Read All</a>
                </div>
                <hr>
              </li>
            
        </ul>



        <!-- Pagination links -->
        <div class="pagination">
          
            <a href="/index.html" class="previous"><i class="fa fa-angle-double-left"></i></a>
            <a href="/page4" class="previous"><i class="fa fa-angle-left"></i></a>
          
          <span class="page_number ">5/6</span>
          
            <a href="/page6" class="next"><i class="fa fa-angle-right"></i></a>
            <a href="/page6" class="next"><i class="fa fa-angle-double-right"></i></a>
          
        </div>
    </div>
    <!-- <button class="anchor"><i class="fa fa-anchor"></i></button> -->
    <div class="right">
        <div class="wrap">
            <div class="side">
                <div>
                    <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                    最新文章
                </div>
                <ul class="content-ul" recent>
                    
                        <li><a href="/2017/01/18/SDiffuseMenu/">AwesomeMenu的Swift版改写之旅:SDiffuseMenu</a></li>
                    
                        <li><a href="/2016/12/11/swift_X_Initialization_Deinitialization/">Swift3.0_X_构造过程和析构过程 </a></li>
                    
                        <li><a href="/2016/12/10/swift_IX_Methods_Subscripts_Inheritance/">Swift3.0_IX_方法、下标和继承 </a></li>
                    
                        <li><a href="/2016/12/08/swift_VIII_Enumerations_Classes_Structures_Properties/">Swift3.0_VIII_枚举、类、结构体、属性</a></li>
                    
                        <li><a href="/2016/12/07/swift_VII_Closures/">Swift3.0_VII_闭包</a></li>
                    
                        <li><a href="/2016/12/05/swift_VI_Functions/">Swift3.0_VI_函数</a></li>
                    
                        <li><a href="/2016/12/03/swift_V_Control-Flow/">Swift3.0_V_控制流</a></li>
                    
                        <li><a href="/2016/12/01/swift_IV_Collection-Types/">Swift3.0_IV_集合</a></li>
                    
                        <li><a href="/2016/11/26/swift_III_Strings-and-Characters/">Swift_III_字符(串)</a></li>
                    
                        <li><a href="/2016/11/22/swift_II_Basic-Operators/">Swift_II_基本运算符</a></li>
                    
                </ul>
            </div>

            <!-- Content -->
            <div class="side ">
                <div>
                    <i class="fa fa-th-list"></i>
                    分类
                </div>
                <ul class="content-ul" cate>
                    
                    <li>
                        <a href="/category/#block" class="categories-list-item" cate="block">
                            <span class="name">
                                block
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#apache" class="categories-list-item" cate="apache">
                            <span class="name">
                                apache
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#WKWebView" class="categories-list-item" cate="WKWebView">
                            <span class="name">
                                WKWebView
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#IOS逆向" class="categories-list-item" cate="IOS逆向">
                            <span class="name">
                                IOS逆向
                            </span>
                            <span class="badge">2</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#NSURLProtocol" class="categories-list-item" cate="NSURLProtocol">
                            <span class="name">
                                NSURLProtocol
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#缓存" class="categories-list-item" cate="缓存">
                            <span class="name">
                                缓存
                            </span>
                            <span class="badge">2</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#NSURLCache" class="categories-list-item" cate="NSURLCache">
                            <span class="name">
                                NSURLCache
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#SecureCRT" class="categories-list-item" cate="SecureCRT">
                            <span class="name">
                                SecureCRT
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#博客" class="categories-list-item" cate="博客">
                            <span class="name">
                                博客
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#jekyll" class="categories-list-item" cate="jekyll">
                            <span class="name">
                                jekyll
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#OS_X" class="categories-list-item" cate="OS_X">
                            <span class="name">
                                OS_X
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#Sublime" class="categories-list-item" cate="Sublime">
                            <span class="name">
                                Sublime
                            </span>
                            <span class="badge">2</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#iOS逆向" class="categories-list-item" cate="iOS逆向">
                            <span class="name">
                                iOS逆向
                            </span>
                            <span class="badge">7</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#IOS基础" class="categories-list-item" cate="IOS基础">
                            <span class="name">
                                IOS基础
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#python" class="categories-list-item" cate="python">
                            <span class="name">
                                python
                            </span>
                            <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#Swift" class="categories-list-item" cate="Swift">
                            <span class="name">
                                Swift
                            </span>
                            <span class="badge">3</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#Swift3.0" class="categories-list-item" cate="Swift3.0">
                            <span class="name">
                                Swift3.0
                            </span>
                            <span class="badge">8</span>
                        </a>
                    </li>
                    
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <div class="side">
                <div>
                    <i class="fa fa-tags"></i>
                    Tags
                </div>
                <div class="tags-cloud">
                    
                    
                    
                    

                    

                    
                      
                      
                      
                      
                      
                      <a href="/tag/#block" style="font-size: 9pt; color: #999;">block</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#apache" style="font-size: 9pt; color: #999;">apache</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#WKWebView、Native与JS、缓存、NSURLProtocol" style="font-size: 9pt; color: #999;">WKWebView、Native与JS、缓存、NSURLProtocol</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#Charles" style="font-size: 9pt; color: #999;">Charles</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#Reveal" style="font-size: 9pt; color: #999;">Reveal</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#iOSOpenDev" style="font-size: 9pt; color: #999;">iOSOpenDev</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#NSURLProtocol" style="font-size: 9pt; color: #999;">NSURLProtocol</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#缓存" style="font-size: 10.5pt; color: #888;">缓存</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#NSURLCache" style="font-size: 9pt; color: #999;">NSURLCache</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#SecureCRT" style="font-size: 9pt; color: #999;">SecureCRT</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#博客" style="font-size: 9pt; color: #999;">博客</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#jekyll" style="font-size: 9pt; color: #999;">jekyll</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#sublime" style="font-size: 9pt; color: #999;">sublime</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#环境变量" style="font-size: 9pt; color: #999;">环境变量</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#Sublime" style="font-size: 10.5pt; color: #888;">Sublime</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#iOS逆向" style="font-size: 9pt; color: #999;">iOS逆向</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#class_dump" style="font-size: 9pt; color: #999;">class_dump</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#Theos" style="font-size: 10.5pt; color: #888;">Theos</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#Logos" style="font-size: 9pt; color: #999;">Logos</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#IOS代码规范" style="font-size: 9pt; color: #999;">IOS代码规范</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#IOS基础" style="font-size: 9pt; color: #999;">IOS基础</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#IDA、iFunBox、dyld_decache" style="font-size: 9pt; color: #999;">IDA、iFunBox、dyld_decache</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#iOS逆向工具集" style="font-size: 9pt; color: #999;">iOS逆向工具集</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#iOS逆向理论基础" style="font-size: 9pt; color: #999;">iOS逆向理论基础</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#爬基金数据" style="font-size: 9pt; color: #999;">爬基金数据</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#脚本" style="font-size: 9pt; color: #999;">脚本</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#Swift" style="font-size: 11.5pt; color: #666;">Swift</a>
                    
                      
                      
                      
                      
                      
                      <a href="/tag/#Swift3.0" style="font-size: 18pt; color: #000;">Swift3.0</a>
                    
                </div>
            </div>

            <!-- <div class="side">
                <div>
                    <i class="fa fa-external-link"></i>
                    Links
                </div>
                <ul  class="content-ul">

                </ul>
            </div> -->
        </div>
    </div>
</div>
<!-- <script src="/js/scroll.min.js " charset="utf-8"></script> -->
<!-- <script src="/js/pageContent.js " charset="utf-8"></script> -->


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             3行代码的技术博客 
        </p>
        <p class="contact">
            Contact me at:  
            <a href="mailto:mythziven@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>   -->
<!--            <a href="mailto:mythziven@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>-->
<!--            <a href="mailto:mythziven@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        -->


        </p>
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
        <p class="power">
        
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>

          <!--   <span>
                Theme designed by <a href="https://github.com/mythkiven">MyKiven</a>.
            </span> -->

        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
